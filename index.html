<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Attendance Report</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL@24..48,100..700,0..1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Add this after html2canvas script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <link rel="stylesheet" href="navbar.css">
    <style>
        :root {
            --primary: #736b23;
            --secondary: #9ade24;
            --accent: #f5de3e;
            --light: #ecf0f1;
            --dark: #0d0a06;
            --text: #333;
            --text-light: #777;
            --gold: #FFD700;
            --silver: #C0C0C0;
            --bronze: #CD7F32;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Sync Notification Styles */
        .sync-notification {
            position: fixed;
            top: 70px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            background: var(--secondary);
            color: white;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            display: flex;
            align-items: center;
            animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s;
        }

        .sync-notification.error {
            background: #ff6b6b;
        }

        .sync-notification.success {
            background: #6bcf7f;
        }

        .sync-notification.warning {
            background: #ffd93d;
            color: #333;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

/* Pulse animation for pending state */
@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
}

/* Spin animation for syncing button */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Sync status indicator states */
#sync-status-indicator.online {
    background: #6bcf7f; /* Green */
    animation: none;
}

#sync-status-indicator.offline {
    background: #ff6b6b; /* Red */
    animation: none;
}

#sync-status-indicator.pending {
    background: #ffd93d; /* Yellow/Orange */
    animation: pulse 1s infinite;
}

/* Manual sync button */
#firebase-sync-button.syncing {
    animation: spin 1s linear infinite;
}

        body {
            font-family: 'Poppins', sans-serif;
            color: var(--text);
            background-color: #f0f0f0;
            margin: 0;
            padding-top: 60px;
            overflow-x: hidden;
            font-weight: 400;
        }

        /* Prevent background scroll when modal is open */
        body.modal-open {
            overflow: hidden;
        }
        
        /* Button Styles */
        .btn-hamburger-menu {
            position: fixed;
            top: 15px;
            right: 20px;
            padding: 10px;
            border-radius: 5px;
            cursor: none;
            background: transparent;
            border: none;
            z-index: 1001;
            color: var(--text);
            transition: all 0.3s ease;
        }

        .btn-hamburger-menu:active {
            color: var(--secondary);
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Hamburger Menu Styles */
        .dropdown-menu {
            position: fixed;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1002;
            display: none;
            min-width: 150px;
            overflow: hidden;
            animation: dropdownFadeIn 0.2s ease-out;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: none;
            color: var(--text);
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:active {
            background: var(--secondary);
            color: var(--light);
        }

        .dropdown-item.active {
            background: var(--secondary);
            color: var(--light);
        }

        /* Overlay to close dropdown when clicking outside */
        .dropdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 1000;
            display: none;
        }

        /* Update existing styles for better spacing */
        .names-form-section {
            padding: 80px 20px;
        }

        /* PAGE TOGGLE SECTION - UPDATED FOR SWIPE */
        .page-toggle-section {
            position: fixed !important;
            top: 15px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            z-index: 1001 !important;
            padding: 8px 16px !important;
            border-radius: 6px !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            margin: 0 !important;
            pointer-events: none !important;
        }

        /* Hide the toggle icons */
        .page-toggle-section .toggle-icon {
            display: none !important;
        }

        .page-toggle-section .toggle-label {
            font-weight: 600 !important;
            color: var(--text) !important;
            font-size: 14px !important;
            margin: 0 !important;
            font-family: 'Poppins', sans-serif !important;
            text-align: center !important;
        }

        /* KERTAS A4 BENAR-BENAR SEPERTI KERTAS CETAK */
        /* Margin dalam (kiri-kanan-atas-bawah) SELALU 20mm di semua orientasi & ukuran layar */
        #print-paper {
            width: 210mm;           /* lebar A4 */
            height: 297mm;          /* tinggi A4 */
            padding: 20mm;          /* INI YANG KAMU MAU: 20mm dari 4 sisi */
            box-sizing: border-box;
            background: white;
            margin: 20px auto;      /* jarak luar dari layar ke kertas */
            box-shadow: 0 4px 25px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            
            /* Make paper swipeable */
            touch-action: pan-y;
            user-select: none;
            
            /* Tetap pakai ukuran mm supaya 100% akurat saat print & di semua device */
            font-family: 'Times New Roman', Times, serif;
            font-size: 14px;
            line-height: 1.4;
        }

        /* Hapus semua padding/margin lain yang mengganggu */
        #print-paper > * {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            box-sizing: border-box;
        }

        .header {
            text-align: center;
            padding: 10px;
            border-bottom: 1px solid #fff;
            position: relative;
            z-index: 0;
        }

        /* LOGO: jarak kiri-kanan-atas-bawah SAMA PERSIS dengan isi lain */
        .logo-wrapper {
            width: 100%;
            text-align: center;
            margin: 0 !important;
            padding: 0 !important;
        }

        .logo-img {
            max-width: 100%;                   /* biar tidak nyentuh tepi */
            height: auto;
            display: block;
            margin: 0 auto;
            margin-top: -100px;
        }

        h4 {
            font-size: 14px;
            margin: 5px 0px;
            font-family: 'Times New Roman', Times, serif;
        }

        p {
            font-size: 14px;
            margin: 5px 0;
        }

        table {
            width: 97%;
            border-collapse: collapse;
            margin: 0 auto;
        }

        th, td {
            border: 1px solid #000;
            font-family: 'Times New Roman', Times, serif;
        }

        th {
            background-color: #fff;
            text-align: center;
            padding: 5px 3px 6px;
            font-size: 14px;
        }

        td {
            text-align: left;
            padding: 2px 5px 5px;
            vertical-align: center;
            font-size: 14px;
        }

        .date {
            font-size: 12px;
        }

        .signature-wrapper {
            width: 100%;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background-color: #fff;
            border: none;
            padding: 5px;
            box-sizing: border-box;
            margin-bottom: -5px;
        }

        .signature img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            object-position: center;
        }

        td:nth-child(1) { background-color: #fff; text-align: center; width: 7%; font-size: 14px; }
        td:nth-child(2) { background-color: #fff; width: 32%; font-size: 14px; }
        td:nth-child(3) { background-color: #fff; width: 15%; font-size: 14px; }
        td:nth-child(4) { background-color: #fff; width: 15%; font-size: 14px; }
        td:nth-child(5) { background-color: #fff; width: 17%; font-size: 14px; }

        .information p {
            text-align: left;
            margin-left: 1.5%;
            font-family: 'Times New Roman', Times, serif;
            font-size: 14px;
        }

        .informations p {
            text-align: left;
            margin-left: 1.5%;
            font-family: 'Times New Roman', Times, serif;
            font-size: 14px;
        }

        .informations {
            margin-top: -55px;
        }

        .keterangan {
            width: 60px;
            height: 25px;
            margin-top: -1.5px;
            font-size: 14px;
            border: none;
            background-color: transparent;
            cursor: none;
            appearance: none;
        }

        .keterangan:focus { outline: none; }

        .signature-section {
            position: relative;
            width: 97%;
            max-width: 97%;
            margin: 30px auto 10px auto;
            height: 20px;
        }

        .signature-section::before {
            content: '';
            position: absolute;
            top: -30.5px;
            left: 1px;
            right: 1px;
            height: 1px;
            background: black;
            transform: translateY(-50%);
        }

        .btn-delete,
        .btn-cancel {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: none;
            transition: all 0.2s ease;
            font-family: 'Times New Roman', Times, serif;
        }
        
        .btn-delete {
            background-color: white;
            color: red;
        }
        
        .btn-delete:active {
            background-color: red;
            color: white;
        }
        
        .btn-cancel {
            background-color: white;
            color: black;
        }
        
        .btn-cancel:active {
            background-color: black;
            color: white;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .btn-hamburger-menu {
                top: 15px;
                right: 15px;
                padding: 8px;
            }
            
            .dropdown-menu {
                top: 55px;
                right: 15px;
            }

            .page-toggle-section {
                top: 15px;
                left: 50%;
                transform: translateX(-50%);
                padding: 6px 12px;
            }
            
            .page-toggle-section .toggle-label {
                font-size: 12px;
            }
            
            .container {
                margin-top: 15px;
                width: 100%;
                height: auto;
                padding: 10mm;
            }
            
            .btn-delete,
            .btn-cancel {
                width: 100%;
            }
        }

        @media print {
            body, .container {
                margin: 0 !important;
                padding: 0 !important;
            }
            .container {
                width: 210mm !important;
                height: 297mm !important;
                padding: 20mm;
            }
            .btn-clear-signatures, nav, .page-toggle-section, .btn-hamburger-menu {
                display: none !important;
            }
        }

        /* Signature number and keterangan container */
        .signature-number {
            font-size: 14px;
            text-align: left;
            margin-bottom: 5px;
        }

        .keterangan-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .keterangan-number {
            font-size: 14px;
        }

        /* Swipe feedback styles */
        .swipe-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            z-index: 9999;
            pointer-events: none;
            animation: fadeInOut 1s ease;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        }

        /* Swipe hint arrows */
        .swipe-hint {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 24px;
            opacity: 0.5;
            z-index: 999;
            pointer-events: none;
            animation: pulseHint 2s infinite;
        }
        
        .swipe-hint-left {
            left: 20px;
        }
        
        .swipe-hint-right {
            right: 20px;
        }
        
        @keyframes pulseHint {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }

        /* firebase-ui.css - CSS untuk Firebase UI elements */
        /* Sync Status Indicator */
        #sync-status-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            z-index: 9999;
            cursor: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        #sync-status-indicator:active {
            transform: scale(1.2);
        }

        #sync-status-indicator.online {
            background: #6bcf7f;
        }

        #sync-status-indicator.offline {
            background: #ff6b6b;
        }

        #sync-status-indicator.pending {
            background: #ffd93d;
            animation: pulse 1s infinite;
        }

        /* Sync Button */
        #firebase-sync-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: none;
            z-index: 999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        #firebase-sync-button:active {
            background: var(--secondary);
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        #firebase-sync-button.syncing {
            animation: spin 1s linear infinite;
        }

        /* Auth Status Indicator */
        #auth-status-indicator {
            position: fixed;
            top: 15px;
            left: 15px;
            padding: 5px 10px;
            background: var(--secondary);
            color: white;
            border-radius: 4px;
            font-size: 11px;
            z-index: 999;
            font-family: 'Poppins', sans-serif;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Organization Indicator */
        #firebase-org-indicator {
            position: fixed;
            top: 15px;
            left: 120px;
            padding: 5px 10px;
            background: rgba(255,255,255,0.9);
            color: var(--text);
            border-radius: 4px;
            font-size: 12px;
            z-index: 999;
            font-family: 'Poppins', sans-serif;
            display: flex;
            align-items: center;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Notifications */
        .firebase-notification {
            position: fixed;
            top: 70px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            background: white;
            color: #333;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            display: flex;
            align-items: center;
            animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s;
        }

        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes modalPop {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
.name-input {
    width: 100%;
    border: none;
    background: transparent;
    font-family: 'Times New Roman', Times, serif;
    font-size: 14px;
    padding: 2px 5px;
    outline: none;
    cursor: none;
}
.info-input {
    border: none;
    background: transparent;
    font-family: 'Times New Roman', Times, serif;
    font-size: 14px;
    padding: 2px 5px;
    outline: none;
    cursor: none;
    min-width: 200px;
    margin-left: 5px;
}

.info-input::placeholder {
    color: #999;
}

/* For PDF download - convert to text */
@media print {
    .info-input {
        border: none !important;
        background: transparent !important;
        padding: 0 !important;
        margin: 0 !important;
        min-width: 0 !important;
    }
}

.title-input {
    width: 100%;
    border: none;
    background: transparent;
    font-family: 'Times New Roman', Times, serif;
    font-size: 14px;
    padding: 0;
    margin: 5px 0;
    outline: none;
    cursor: none;
    text-align: center;
    font-weight: normal;
}

.title-input::placeholder {
    color: #999;
}

/* Style for h4 elements containing title inputs */
.header h4 {
    margin: 5px 0;
    text-align: center;
}

/* For PDF download - convert to text */
@media print {
    .title-input {
        border: none !important;
        background: transparent !important;
        padding: 0 !important;
        margin: 0 !important;
    }
}

/* Remove the old title styling if it exists */
#report-title1,
#report-title2,
#report-title3 {
    all: unset;
    display: block;
    width: 100%;
}
.date-input {
    border: none;
    background: transparent;
    font-family: 'Times New Roman', Times, serif;
    font-size: 12px;
    padding: 2px;
    outline: none;
    cursor: none;
    text-align: center;
    width: 100%;
    display: block;
}

.date-input::placeholder {
    color: #999;
}

/* Style for the date cell in table header */
th .date-input {
    font-weight: normal;
}

/* For PDF download - convert to text */
@media print {
    .date-input {
        border: none !important;
        background: transparent !important;
        padding: 0 !important;
        margin: 0 !important;
    }
}

/* Login Modal Styles */
.login-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
}

.login-modal {
    background: white;
    border-radius: 10px;
    padding: 30px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    position: relative;
    animation: modalPop 0.3s ease;
}

.login-modal-content h3 {
    margin-top: 0;
    margin-bottom: 20px;
    color: var(--text);
    font-family: 'Poppins', sans-serif;
    font-weight: 600;
    text-align: center;
}

.login-modal-content .firebase-login-subtitle {
    text-align: center;
    color: var(--text-light);
    margin-bottom: 25px;
    font-size: 14px;
}

.login-input-group {
    margin-bottom: 20px;
}

.login-input {
    width: 100%;
    padding: 12px 15px;
    border-radius: 6px;
    font-family: 'Poppins', sans-serif;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.login-input:focus {
    outline: none;
}

.login-password-container {
    position: relative;
}

.show-password {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: none;
    color: #666;
    padding: 5px;
}

.login-error {
    color: red;
    font-size: 13px;
    margin: 10px 0;
    padding: 8px 12px;
    background: #fff5f5;
    border-radius: 4px;
    display: none;
}

.login-button-group {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.login-btn, .register-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 6px;
    font-family: 'Poppins', sans-serif;
    font-weight: 500;
    cursor: none;
    transition: all 0.3s ease;
}

.login-btn {
    background: var(--secondary);
    color: white;
}

.login-btn:active {
    background: var(--secondary);
}

.register-btn {
    background: #f0f0f0;
    color: var(--text);
}

.register-btn:active {
    background: #e0e0e0;
}

.continue-offline {
    text-align: center;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

.continue-btn {
    background: transparent;
    border: 1px solid #ddd;
    color: var(--text-light);
    padding: 10px 20px;
    border-radius: 6px;
    cursor: none;
    font-family: 'Poppins', sans-serif;
    transition: all 0.3s ease;
}

.continue-btn:active {
    background: #f5f5f5;
    border-color: #ccc;
}

.login-close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: none;
    color: #666;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Login status indicator in dropdown */
.dropdown-item.login-button.logged-in {
    background: var(--secondary);
    color: white;
}

.login-user-info {
    font-size: 12px;
    opacity: 0.8;
    margin-top: 3px;
}

/* Style for login button in dropdown */
.login-button .material-symbols-outlined {
    vertical-align: middle;
    margin-right: 8px;
}

/* Make login button positioned at bottom */
.dropdown-item.login-button {
    margin-top: auto;
    background: white;
}

.dropdown-item.login-button:active {
    background: var(--secondary);
    color: white;
}

/* Disabled input styles when not logged in */
body:not(.user-logged-in) .title-input:not(:focus),
body:not(.user-logged-in) .info-input:not(:focus),
body:not(.user-logged-in) .name-input:not(:focus) {
    background-color: #f9f9f9;
    cursor: not-allowed;
    color: #666;
}

/* Enable signature even when not logged in */
.signature-wrapper {
    cursor: none !important;
}

.division-toggle-group {
    display: flex;
    align-items: center;
}

.division-select {
    width: 100%;
    padding: 8px 12px;
    border-radius: 4px;
    background: white;
    font-family: 'Poppins', sans-serif;
    font-size: 13px;
    color: var(--text);
    cursor: none;
    outline: none;
}

/* Gender Selector Styles */
.gender-toggle-group {
    display: flex;
    align-items: center;
}

.gender-select {
    width: 100%;
    padding: 8px 12px;
    border-radius: 4px;
    background: transparent;
    font-family: 'Poppins', sans-serif;
    font-size: 13px;
    color: var(--text);
    cursor: none;
    outline: none;
    transition: border-color 0.3s ease;
}

/* Division indicator with gender */
#division-indicator {
    display: inline-block;
    margin-left: 8px;
    padding: 2px 6px;
    background: var(--secondary);
    color: white;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 500;
}

#gender-indicator {
    display: inline-block;
    margin-left: 4px;
    padding: 2px 6px;
    background: var(--secondary);
    color: white;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 500;
}

/* Add this to your existing CSS styles */
#fallback-download-btn:active {
    color: var(--secondary) !important;
}

</style>
</head>
<body>
    <nav class="navbar">
    </nav>
    
    <!-- Hamburger Menu Button -->
    <button id="hamburger-menu" class="btn-hamburger-menu">
        <span class="material-symbols-outlined">menu</span>
    </button>
    
<!-- Dropdown Menu -->
<div id="dropdown-menu" class="dropdown-menu">
    <div class="dropdown-item" data-value="one-page">One Page</div>
    <div class="dropdown-item" data-value="two-page">Two Pages</div>
    <div class="dropdown-item" data-value="three-page">Three Pages</div>
    <div class="dropdown-item" data-value="four-page">Four Pages</div>
    <div class="dropdown-item" data-value="five-page">Five Pages</div>
    
<!-- Division Selector -->
<div class="dropdown-section">
    <div class="dropdown-section-label">Division:</div>
    <div class="division-toggle-group">
        <select id="division-select" class="division-select">
            <option value="Khusus">Khusus</option>
            <option value="Sekum">Sekum</option>
            <option value="Benduk">Benduk</option>
            <option value="PSDM">PSDM</option>
            <option value="Syidak">Syidak</option>
            <option value="DKMA">DKMA</option>
            <option value="JWR">JWR</option>
        </select>
    </div>
</div>

<!-- Gender Selector (shown immediately) -->
<div class="dropdown-section" id="gender-section">
    <div class="dropdown-section-label">Gender:</div>
    <div class="gender-toggle-group">
        <select id="gender-select" class="gender-select">
            <option value="Ikhwan">Ikhwan</option>
            <option value="Akhwat">Akhwat</option>
        </select>
    </div>
</div>
    
    <!-- Login Button at bottom -->
    <div class="dropdown-item login-button" id="dropdown-login-button">
        <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px; margin-right: 8px;">
            login
        </span>
        Login
    </div>
</div>

    <!-- Page Toggle Section - Now just shows page number -->
    <div class="page-toggle-section">
        <div class="toggle-container">
            <span class="toggle-label" id="reportToggleLabel"></span>
        </div>
    </div>
    
    <div id="print-paper">
        <div id="report-container">
<div class="header">
    <div class="logo-wrapper">
        <img src="logo.png" class="logo-img" alt="Organization Logo">
    </div>
    <h4>
        <input type="text" class="title-input" id="report-title1" placeholder="PRESENSI KEHADIRAN PESERTA">
    </h4>
    <h4>
        <input type="text" class="title-input" id="report-title2" placeholder="NAMA PROGRAM KERJA">
    </h4>
    <h4>
        <input type="text" class="title-input" id="report-title3" placeholder="MASA BAKTI TAHUN/TAHUN">
    </h4>
</div>
<div class="information">
    <p>Waktu&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:
        <input type="text" class="info-input" id="waktu-input" placeholder="00.00â€“00.00">
    </p>
    <p>Tempat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:
        <input type="text" class="info-input" id="tempat-input" placeholder="ruang kelas 0 0">
    </p>
    <p>Keterangan&nbsp;&nbsp;&nbsp;:
        <input type="text" class="info-input" id="keterangan-input" placeholder="syura riksasi Nama Proker">
    </p>
</div>
            <table border="1">
                <thead>
                    <tr>
                        <th rowspan="2">NO.</th>
                        <th rowspan="2">NAMA</th>
                        <th colspan="3"><input type="text" class="date-input" id="report-date" placeholder="hari, 00 bulan tahun"></th>
                    </tr>
                    <tr>
                        <th colspan="2">TANDA TANGAN</th>
                        <th>KETERANGAN</th>
                    </tr>
                </thead>
                <tbody id="report-table-body">
                    <!-- Dynamically populated by JavaScript -->
                </tbody>
            </table>
            <div class="signature-section">
                <div class="end-line left"></div>
                <div class="end-line right"></div>
            </div>
            <div class="informations">
                <p>Keterangan :</p>
                <p>1. Izin: <b>I</b></p>
                <p>2. Sakit: <b>S</b></p>
                <p>3. Tanpa keterangan: <b>TK</b></p>
            </div>
        </div>
    </div>
    
    <!-- Sync Status Indicator -->
<div id="sync-status-indicator" title="Sync Status"></div>

<!-- Manual Sync Button -->
<button id="firebase-sync-button" class="btn-sync" title="Manual Sync">
    <span class="material-symbols-outlined">sync</span>
</button>
    <script>// Complete JavaScript for index.html WITH DIVISION AND GENDER SEPARATE FILES
document.addEventListener('DOMContentLoaded', () => {
    console.log('report.js: DOM loaded');
    
    const defaultTitles = ["", "", ""];
    let currentPage = localStorage.getItem('currentPage') || '1';
    let displayMode = localStorage.getItem('displayMode') || 'one-page';
    let currentDivision = localStorage.getItem('currentDivision') || 'Khusus';
    let currentGender = localStorage.getItem('currentGender') || 'Ikhwan';
    let rowHeaderNames = [];
    
    // Page toggle elements
    const toggleLabel = document.getElementById('reportToggleLabel');
    const toggleSection = document.querySelector('.page-toggle-section');
    const hamburgerMenu = document.getElementById('hamburger-menu');
    const dropdownMenu = document.getElementById('dropdown-menu');
    
    // ========== SWIPE GESTURE VARIABLES ==========
    let touchStartX = 0;
    let touchEndX = 0;
    let isSwiping = false;
    let swipeStartTime = 0;

    // ========== KEY MANAGEMENT FUNCTIONS ==========
    function getFullDivisionKey(key) {
        return `${currentDivision}_${currentGender}_${key}`;
    }

    function loadAttendanceNames() {
        const divisionKey = getFullDivisionKey('attendanceNames');
        const saved = localStorage.getItem(divisionKey);
        rowHeaderNames = saved ? JSON.parse(saved) : [];
        console.log(`Loaded names for ${currentDivision}_${currentGender}:`, rowHeaderNames.length, 'names');
        return rowHeaderNames;
    }
    
    function saveAttendanceNames() {
        const divisionKey = getFullDivisionKey('attendanceNames');
        localStorage.setItem(divisionKey, JSON.stringify(rowHeaderNames));
        console.log(`Saved names for ${currentDivision}_${currentGender}:`, rowHeaderNames.length, 'names');
    }
    
    function cleanupTrailingEmptyPairs() {
        for (let i = rowHeaderNames.length - 1; i >= 0; i -= 2) {
            const name1 = rowHeaderNames[i - 1] || '';
            const name2 = rowHeaderNames[i] || '';
            
            if (name1.trim() === '' && name2.trim() === '') {
                rowHeaderNames.pop();
                rowHeaderNames.pop();
                console.log('Removed trailing empty pair');
            } else {
                break;
            }
        }
        
        saveAttendanceNames();
    }
    
    function saveNameAtIndex(index, name) {
        loadAttendanceNames();
        
        while (rowHeaderNames.length <= index) {
            rowHeaderNames.push('');
        }
        
        rowHeaderNames[index] = name;
        
        cleanupTrailingEmptyPairs();
        
        console.log(`Saved name for ${currentDivision}_${currentGender}:`, {index, name, totalNames: rowHeaderNames.length});
        
        generateTableRows();
        
        window.dispatchEvent(new CustomEvent('namesUpdate'));
    }

    function saveAttendanceInfo() {
        const waktu = document.getElementById('waktu-input')?.value || "";
        const tempat = document.getElementById('tempat-input')?.value || "";
        const keterangan = document.getElementById('keterangan-input')?.value || "";
        
        const attendanceInfo = {
            waktu,
            tempat,
            keterangan
        };
        
        localStorage.setItem(getFullDivisionKey('attendanceInfo'), JSON.stringify(attendanceInfo));
        console.log(`Attendance info saved for ${currentDivision}_${currentGender}:`, attendanceInfo);
    }
    
    function loadAttendanceInfo() {
        const savedInfo = JSON.parse(localStorage.getItem(getFullDivisionKey('attendanceInfo')) || '{}');
        
        const waktuInput = document.getElementById('waktu-input');
        const tempatInput = document.getElementById('tempat-input');
        const keteranganInput = document.getElementById('keterangan-input');
        
        if (waktuInput) waktuInput.value = savedInfo.waktu || "";
        if (tempatInput) tempatInput.value = savedInfo.tempat || "";
        if (keteranganInput) keteranganInput.value = savedInfo.keterangan || "";
    }
    
    function saveReportTitles() {
        const title1 = document.getElementById('report-title1')?.value || "";
        const title2 = document.getElementById('report-title2')?.value || "";
        const title3 = document.getElementById('report-title3')?.value || "";
        
        const reportTitles = [title1, title2, title3];
        localStorage.setItem(getFullDivisionKey('reportTitles'), JSON.stringify(reportTitles));
        console.log(`Report titles saved for ${currentDivision}_${currentGender}:`, reportTitles);
    }
    
    function loadTitles() {
        const savedTitles = JSON.parse(localStorage.getItem(getFullDivisionKey('reportTitles')) || '[]');
        const defaultTitles = ["", "", ""];
        
        const title1 = document.getElementById('report-title1');
        const title2 = document.getElementById('report-title2');
        const title3 = document.getElementById('report-title3');
        
        if (title1) title1.value = savedTitles[0] || defaultTitles[0];
        if (title2) title2.value = savedTitles[1] || defaultTitles[1];
        if (title3) title3.value = savedTitles[2] || defaultTitles[2];
    }

    function setDynamicDate() {
        const dateDiv = document.getElementById('report-date');
        const savedData = localStorage.getItem(getFullDivisionKey('tanggalPresensi'));
        
        if (savedData) {
            dateDiv.value = savedData;
        } else {
            const today = new Date();
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jum\'at', 'Sabtu'];
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            dateDiv.value = `${days[today.getDay()]}, ${today.getDate()} ${months[today.getMonth()]} ${today.getFullYear()}`;
        }
    }
    
    function loadDivisionData() {
        console.log(`Loading data for division: ${currentDivision}_${currentGender}`);
        
        // Load attendance names
        loadAttendanceNames();
        
        // Load titles
        loadTitles();
        
        // Load attendance info
        loadAttendanceInfo();
        
        // Load date
        setDynamicDate();
        
        // Load signatures
        loadSignaturesAndKeterangan();
    }
    
    function saveDivisionData() {
        console.log(`Saving data for division: ${currentDivision}_${currentGender}`);
        
        // Save attendance names
        saveAttendanceNames();
        
        // Save titles
        saveReportTitles();
        
        // Save attendance info
        saveAttendanceInfo();
        
        // Save date
        const dateInput = document.querySelector('.date-input');
        if (dateInput) {
            localStorage.setItem(getFullDivisionKey('tanggalPresensi'), dateInput.value);
        }
    }

    // ========== MIGRATE OLD DATA ==========
    function migrateOldData() {
        console.log('Checking for old data migration...');
        
        // List of data keys to migrate
        const dataKeys = [
            'attendanceNames',
            'attendanceInfo', 
            'reportTitles',
            'tanggalPresensi',
            'spreadsheetData'
        ];
        
        // Get all divisions
        const divisions = ['Khusus', 'Sekum', 'Benduk', 'PSDM', 'Syidak', 'DKMA', 'JWR'];
        const genders = ['Ikhwan', 'Akhwat'];
        
        // For each division and gender
        divisions.forEach(division => {
            genders.forEach(gender => {
                dataKeys.forEach(key => {
                    // Check for old key (without gender)
                    const oldKey = `${division}_${key}`;
                    const newKey = `${division}_${gender}_${key}`;
                    
                    // If old data exists and new data doesn't exist yet
                    const oldData = localStorage.getItem(oldKey);
                    const newData = localStorage.getItem(newKey);
                    
                    if (oldData && !newData) {
                        // Migrate Ikhwan data from old format
                        if (gender === 'Ikhwan') {
                            localStorage.setItem(newKey, oldData);
                            console.log(`Migrated ${oldKey} to ${newKey}`);
                            
                            // For spreadsheetData, we need to keep the data for both genders
                            if (key === 'spreadsheetData') {
                                try {
                                    const parsedData = JSON.parse(oldData);
                                    localStorage.setItem(newKey, JSON.stringify(parsedData));
                                } catch (e) {
                                    console.error('Error migrating spreadsheetData:', e);
                                }
                            }
                        }
                    }
                });
            });
        });
    }

    // ========== MAIN VIEW FUNCTIONS ==========
    function updateActiveDropdownItem() {
        const items = ['one-page', 'two-page', 'three-page', 'four-page', 'five-page'];
        
        items.forEach(item => {
            const element = document.querySelector(`[data-value="${item}"]`);
            if (element) {
                element.classList.toggle('active', displayMode === item);
            }
        });
    }

    function updateReportView() {
        let totalPages = 1;
        switch(displayMode) {
            case 'one-page': totalPages = 1; break;
            case 'two-page': totalPages = 2; break;
            case 'three-page': totalPages = 3; break;
            case 'four-page': totalPages = 4; break;
            case 'five-page': totalPages = 5; break;
        }
        
        if (displayMode === 'one-page') {
            if (toggleSection) {
                toggleSection.style.display = 'flex';
                toggleLabel.textContent = `All Names - ${currentDivision} ${currentGender}`;
            }
            
            document.querySelectorAll('.swipe-hint').forEach(hint => hint.remove());
        } else {
            if (toggleSection) {
                toggleSection.style.display = 'flex';
                toggleLabel.textContent = `${currentDivision} ${currentGender} - Page ${currentPage} of ${totalPages}`;
            }
            
            showSwipeHints();
        }
        
        updateVisibility();
        generateTableRows();
        updateActiveDropdownItem();
    }

    function updateVisibility() {
        const header = document.querySelector('.header');
        const information = document.querySelector('.information');
        const informations = document.querySelector('.informations');
        
        if (displayMode === 'one-page') {
            header.style.display = 'block';
            information.style.display = 'block';
            informations.style.display = 'block';
            
            document.querySelectorAll('.header h4').forEach(h4 => {
                h4.style.display = 'block';
            });
        } else {
            if (currentPage === '1') {
                header.style.display = 'block';
                document.querySelectorAll('.header h4').forEach(h4 => {
                    h4.style.display = 'block';
                });
                information.style.display = 'block';
                informations.style.display = 'none';
            } else {
                header.style.display = 'block';
                document.querySelectorAll('.header h4').forEach(h4 => {
                    h4.style.display = 'none';
                });
                information.style.display = 'none';
                informations.style.display = 'block';
            }
        }
    }

    // ========== SWIPE GESTURE FUNCTIONS ==========
    function initializeSwipeGestures() {
        const paperElement = document.getElementById('print-paper');
        if (!paperElement) return;
        
        console.log('Initializing swipe gestures...');
        
        paperElement.addEventListener('touchstart', handleTouchStart, { passive: true });
        paperElement.addEventListener('touchmove', handleTouchMove, { passive: true });
        paperElement.addEventListener('touchend', handleTouchEnd);
        
        paperElement.addEventListener('mousedown', handleMouseDown);
        paperElement.addEventListener('mousemove', handleMouseMove);
        paperElement.addEventListener('mouseup', handleMouseUp);
        paperElement.addEventListener('mouseleave', handleMouseCancel);
        
        document.addEventListener('keydown', handleKeyDown);
        
        console.log('Swipe gestures initialized successfully');
    }
    
    function handleTouchStart(e) {
        if (displayMode === 'one-page') return;
        
        touchStartX = e.touches[0].clientX;
        touchEndX = touchStartX;
        swipeStartTime = Date.now();
        isSwiping = true;
    }
    
    function handleTouchMove(e) {
        if (!isSwiping || displayMode === 'one-page') return;
        
        touchEndX = e.touches[0].clientX;
    }
    
    function handleTouchEnd(e) {
        if (!isSwiping || displayMode === 'one-page') {
            isSwiping = false;
            return;
        }
        
        const swipeDistance = touchEndX - touchStartX;
        const swipeDuration = Date.now() - swipeStartTime;
        const minSwipeDistance = 50;
        const maxSwipeDuration = 500;
        
        if (swipeDuration > maxSwipeDuration) {
            isSwiping = false;
            return;
        }
        
        if (Math.abs(swipeDistance) < minSwipeDistance) {
            isSwiping = false;
            return;
        }
        
        if (swipeDistance > 0) {
            goToPreviousPage();
        } else {
            goToNextPage();
        }
        
        isSwiping = false;
    }
    
    function handleMouseDown(e) {
        if (displayMode === 'one-page') return;
        
        touchStartX = e.clientX;
        touchEndX = touchStartX;
        swipeStartTime = Date.now();
        isSwiping = true;
    }
    
    function handleMouseMove(e) {
        if (!isSwiping || displayMode === 'one-page') return;
        
        touchEndX = e.clientX;
    }
    
    function handleMouseUp(e) {
        if (!isSwiping || displayMode === 'one-page') {
            isSwiping = false;
            return;
        }
        
        const swipeDistance = touchEndX - touchStartX;
        const swipeDuration = Date.now() - swipeStartTime;
        const minSwipeDistance = 30;
        const maxSwipeDuration = 300;
        
        if (swipeDuration > maxSwipeDuration) {
            isSwiping = false;
            return;
        }
        
        if (Math.abs(swipeDistance) < minSwipeDistance) {
            isSwiping = false;
            return;
        }
        
        if (swipeDistance > 0) {
            goToPreviousPage();
        } else {
            goToNextPage();
        }
        
        isSwiping = false;
    }
    
    function handleMouseCancel() {
        isSwiping = false;
    }
    
    function handleKeyDown(e) {
        if (displayMode === 'one-page') return;
        
        if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
            e.preventDefault();
            goToPreviousPage();
        } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
            e.preventDefault();
            goToNextPage();
        }
    }
    
    function goToPreviousPage() {
        if (displayMode === 'one-page') return;
        
        const currentPageNum = parseInt(currentPage);
        if (currentPageNum > 1) {
            currentPage = (currentPageNum - 1).toString();
            localStorage.setItem('currentPage', currentPage);
            updateReportView();
            
            window.dispatchEvent(new CustomEvent('syncPageChange', { 
                detail: { 
                    page: parseInt(currentPage),
                    mode: displayMode 
                } 
            }));
        }
    }
    
    function goToNextPage() {
        if (displayMode === 'one-page') return;
        
        let totalPages = 1;
        switch(displayMode) {
            case 'two-page': totalPages = 2; break;
            case 'three-page': totalPages = 3; break;
            case 'four-page': totalPages = 4; break;
            case 'five-page': totalPages = 5; break;
        }
        
        const currentPageNum = parseInt(currentPage);
        if (currentPageNum < totalPages) {
            currentPage = (currentPageNum + 1).toString();
            localStorage.setItem('currentPage', currentPage);
            updateReportView();
            
            window.dispatchEvent(new CustomEvent('syncPageChange', { 
                detail: { 
                    page: parseInt(currentPage),
                    mode: displayMode 
                } 
            }));
        }
    }
    
    function showSwipeFeedback(message) {
        const existingFeedback = document.querySelector('.swipe-feedback');
        if (existingFeedback) existingFeedback.remove();
        
        const feedback = document.createElement('div');
        feedback.className = 'swipe-feedback';
        feedback.textContent = message;
        
        document.body.appendChild(feedback);
        
        setTimeout(() => {
            if (feedback.parentNode) feedback.remove();
        }, 800);
    }
    
    function showSwipeHints() {
        if (displayMode === 'one-page') return;
        
        if (localStorage.getItem('swipeHintsShown') === 'true') return;
        
        document.querySelectorAll('.swipe-hint').forEach(hint => hint.remove());
    }

    // ========== TABLE GENERATION ==========
    function generateTableRows() {
        loadAttendanceNames();
        
        const tbody = document.getElementById('report-table-body');
        tbody.innerHTML = '';
        
        let startIndex, endIndex, displayOffset, rowsToGenerate;
        
        if (displayMode === 'one-page') {
            startIndex = 0;
            rowsToGenerate = Math.min(16, Math.max(16, rowHeaderNames.length));
            displayOffset = 1;
        } else {
            const pageNumber = parseInt(currentPage) - 1;
            startIndex = pageNumber * 20;
            rowsToGenerate = 20;
            displayOffset = startIndex + 1;
        }
        
        for (let i = 0; i < rowsToGenerate; i += 2) {
            const actualIndex1 = startIndex + i;
            const actualIndex2 = startIndex + i + 1;
            const displayNumber1 = i + displayOffset;
            const displayNumber2 = i + displayOffset + 1;
            
            const name1 = rowHeaderNames[actualIndex1] || '';
            const name2 = rowHeaderNames[actualIndex2] || '';
            
            // Determine if signatures should be enabled based on names
            const hasName1 = name1 && name1.trim() !== '';
            const hasName2 = name2 && name2.trim() !== '';
            
            // Create first row of the pair
            const row1 = document.createElement('tr');
            row1.innerHTML = `
                <td>${displayNumber1}.</td>
                <td>
                    <input type="text" 
                           class="name-input" 
                           value="${name1}" 
                           data-index="${actualIndex1}"
                           placeholder="Nama">
                </td>
                <td rowspan="2">
                    <div class="signature-number">${displayNumber1}.</div>
                    <div class="signature-wrapper ${hasName1 ? '' : 'disabled'}" 
                         data-name="${name1}" 
                         data-display-number="${displayNumber1}"
                         data-has-name="${hasName1}"
                         data-row-index="${actualIndex1}">
                        <div class="signature" data-name="${name1}" data-index="${actualIndex1}"></div>
                    </div>
                </td>
                <td rowspan="2">
                    <div class="signature-number">${displayNumber2}.</div>
                    <div class="signature-wrapper ${hasName2 ? '' : 'disabled'}" 
                         data-name="${name2}" 
                         data-display-number="${displayNumber2}"
                         data-has-name="${hasName2}"
                         data-row-index="${actualIndex2}">
                        <div class="signature" data-name="${name2}" data-index="${actualIndex2}"></div>
                    </div>
                </td>
                <td>
                    <div class="keterangan-container">
                        <span class="keterangan-number">${displayNumber1}.</span>
                        <select class="keterangan" data-name="${name1}" data-index="${actualIndex1}" ${!hasName1 ? 'disabled' : ''}>
                            <option value=""> </option>
                            <option value="I">I</option>
                            <option value="S">S</option>
                            <option value="TK">TK</option>
                        </select>
                    </div>
                </td>
            `;
            tbody.appendChild(row1);
            
            // Create second row of the pair
            const row2 = document.createElement('tr');
            row2.innerHTML = `
                <td>${displayNumber2}.</td>
                <td>
                    <input type="text" 
                           class="name-input" 
                           value="${name2}" 
                           data-index="${actualIndex2}"
                           placeholder="Nama">
                </td>
                <td>
                    <div class="keterangan-container">
                        <span class="keterangan-number">${displayNumber2}.</span>
                        <select class="keterangan" data-name="${name2}" data-index="${actualIndex2}" ${!hasName2 ? 'disabled' : ''}>
                            <option value=""> </option>
                            <option value="I">I</option>
                            <option value="S">S</option>
                            <option value="TK">TK</option>
                        </select>
                    </div>
                </td>
            `;
            tbody.appendChild(row2);
        }
        
        attachEventListeners();
        loadSignaturesAndKeterangan();
        console.log(`Table generated for ${currentDivision}_${currentGender} page ${currentPage}, showing ${rowsToGenerate} rows`);
    }

    // ========== SIGNATURE & KETERANGAN FUNCTIONS ==========
    function loadSignaturesAndKeterangan() {
        const divisionKey = getFullDivisionKey('spreadsheetData');
        const data = JSON.parse(localStorage.getItem(divisionKey)) || {};
        
        console.log(`Loading signatures & keterangan for ${currentDivision}_${currentGender}:`, data);

        // Process each signature element
        document.querySelectorAll('.signature').forEach(div => {
            const name = div.dataset.name || '';
            const index = parseInt(div.dataset.index);
            const wrapper = div.closest('.signature-wrapper');
            const hasName = wrapper?.dataset.hasName === 'true';
            
            // Clear if no name or wrapper is disabled
            if (!hasName || !name || name.trim() === '') {
                div.innerHTML = '';
                return;
            }
            
            // Try to load signature
            if (data[name] && data[name].image) {
                const img = document.createElement('img');
                img.src = data[name].image;
                img.style.cssText = 'max-width:100%; max-height:100%; object-fit:contain; display: block;';
                img.title = `Signature for ${name}`;
                div.innerHTML = '';
                div.appendChild(img);
            } else {
                // Try case-insensitive match
                const normalizedName = name.toLowerCase().trim();
                const matchingKey = Object.keys(data).find(key =>
                    key.toLowerCase().trim() === normalizedName
                );
                
                if (matchingKey && data[matchingKey]?.image) {
                    const img = document.createElement('img');
                    img.src = data[matchingKey].image;
                    img.style.cssText = 'max-width:100%; max-height:100%; object-fit:contain; display: block;';
                    img.alt = `Signature for ${name}`;
                    img.title = `Signature for ${name}`;
                    div.innerHTML = '';
                    div.appendChild(img);
                    
                    // Update the data-name to match the stored key
                    div.dataset.name = matchingKey;
                    if (wrapper) {
                        wrapper.dataset.name = matchingKey;
                    }
                } else {
                    div.innerHTML = '';
                }
            }
        });
        
        // Process each keterangan select
        document.querySelectorAll('.keterangan').forEach(select => {
            const name = select.dataset.name || '';
            const index = parseInt(select.dataset.index);
            const nameInput = document.querySelector(`.name-input[data-index="${index}"]`);
            const hasName = nameInput && nameInput.value.trim() !== '';
            
            // Disable if no name
            if (!hasName || !name || name.trim() === '') {
                select.value = '';
                select.disabled = true;
                select.style.backgroundColor = '#f5f5f5';
                return;
            }
            
            // Enable and load value
            select.disabled = false;
            select.style.backgroundColor = '';
            
            // First check exact match
            if (data[name] && data[name].keterangan !== undefined) {
                select.value = data[name].keterangan;
            } else {
                // Try case-insensitive match
                const normalizedName = name.toLowerCase().trim();
                const matchingKey = Object.keys(data).find(key =>
                    key.toLowerCase().trim() === normalizedName &&
                    data[key].keterangan !== undefined
                );
                
                if (matchingKey) {
                    select.value = data[matchingKey].keterangan;
                    // Update data-name to match
                    select.dataset.name = matchingKey;
                    console.log(`Loaded keterangan for "${name}" from matching key "${matchingKey}": ${data[matchingKey].keterangan}`);
                } else {
                    // Keep existing value if any, otherwise set to empty
                    select.value = select.value || '';
                }
            }
        });
        
        updateSignatureIndicators();
    }

    function saveKeterangan(name, keterangan) {
    if (!name || name.trim() === '') {
        console.warn('Cannot save keterangan for empty name');
        return;
    }
    
    const divisionKey = getFullDivisionKey('spreadsheetData');
    const data = JSON.parse(localStorage.getItem(divisionKey) || '{}');
    
    // Initialize if doesn't exist
    if (!data[name]) {
        data[name] = {};
    }
    
    // Save keterangan
    data[name].keterangan = keterangan;
    
    // Save back to localStorage
    localStorage.setItem(divisionKey, JSON.stringify(data));
    console.log(`Saved keterangan for "${name}": "${keterangan}" in ${divisionKey}`);
    
    // Save to Firebase if available
    if (window.dbManager && window.dbManager.isInitialized) {
        // Get signature image if exists
        const signatureImage = data[name]?.image || '';
        
        window.dbManager.saveSignature(name, signatureImage, keterangan)
            .then(result => {
                if (result.success) {
                    console.log(`âœ… Firebase: Saved keterangan for "${name}"`);
                } else {
                    console.warn(`âš ï¸ Firebase: Failed to save keterangan for "${name}":`, result.error);
                }
            })
            .catch(error => {
                console.error(`âŒ Firebase: Error saving keterangan for "${name}":`, error);
            });
    }
    
    // Trigger storage event for other tabs/windows
    window.dispatchEvent(new StorageEvent('storage', {
        key: divisionKey,
        newValue: JSON.stringify(data)
    }));
}

    function updateSignatureAndKeteranganForIndex(index, newName) {
        const hasName = newName && newName.trim() !== '';
        
        // Find the signature wrapper for this index
        const signatureWrapper = document.querySelector(`.signature-wrapper[data-row-index="${index}"]`);
        
        if (signatureWrapper) {
            // Update wrapper attributes
            signatureWrapper.dataset.name = newName;
            signatureWrapper.dataset.hasName = hasName;
            
            // Update visual state
            if (hasName) {
                signatureWrapper.classList.remove('disabled');
                signatureWrapper.style.cursor = 'none';
                signatureWrapper.title = `Click to add signature for ${newName}`;
            } else {
                signatureWrapper.classList.add('disabled');
                signatureWrapper.style.cursor = 'not-allowed';
                signatureWrapper.title = 'Enter a name first to add signature';
                
                // Clear any existing signature display
                const signatureDiv = signatureWrapper.querySelector('.signature');
                if (signatureDiv) {
                    signatureDiv.innerHTML = '';
                    
                    // Also remove from localStorage if exists
                    const divisionKey = getFullDivisionKey('spreadsheetData');
                    const data = JSON.parse(localStorage.getItem(divisionKey)) || {};
                    if (data[newName]) {
                        delete data[newName];
                        localStorage.setItem(divisionKey, JSON.stringify(data));
                        
                        // Fire storage event to sync
                        window.dispatchEvent(new StorageEvent('storage', {
                            key: divisionKey,
                            newValue: JSON.stringify(data)
                        }));
                    }
                }
            }
            
            // Update the signature div
            const signatureDiv = signatureWrapper.querySelector('.signature');
            if (signatureDiv) {
                signatureDiv.dataset.name = newName;
            }
        }
        
        // Find and update keterangan select for this index
        const keteranganSelect = document.querySelector(`.keterangan[data-index="${index}"]`);
        if (keteranganSelect) {
            keteranganSelect.dataset.name = newName;
            
            if (hasName) {
                keteranganSelect.disabled = false;
                keteranganSelect.title = `Select keterangan for ${newName}`;
            } else {
                keteranganSelect.disabled = true;
                keteranganSelect.value = '';
                keteranganSelect.title = 'Enter a name first';
                
                // Clear keterangan from localStorage
                const divisionKey = getFullDivisionKey('spreadsheetData');
                const data = JSON.parse(localStorage.getItem(divisionKey)) || {};
                if (data[newName] && data[newName].keterangan) {
                    delete data[newName].keterangan;
                    
                    // If no image either, remove the entire entry
                    if (!data[newName].image) {
                        delete data[newName];
                    }
                    localStorage.setItem(divisionKey, JSON.stringify(data));
                }
            }
        }
        
        // Update the signature number display
        const signatureNumber = document.querySelector(`.signature-wrapper[data-row-index="${index}"] .signature-number`);
        if (signatureNumber) {
            if (!hasName) {
                signatureNumber.style.opacity = '0.5';
            } else {
                signatureNumber.style.opacity = '1';
            }
        }
        
        // Trigger storage update event
        window.dispatchEvent(new CustomEvent('storageUpdate'));
        
        console.log(`Updated signature and keterangan for ${currentDivision}_${currentGender} index ${index}: ${newName || '(empty)'}`);
    }

    function updateSignatureIndicators() {
        document.querySelectorAll('.signature-wrapper').forEach(wrapper => {
            const name = wrapper.dataset.name || '';
            const hasName = wrapper.dataset.hasName === 'true';
            const displayNumber = wrapper.dataset.displayNumber;
            
            // Remove existing event listener to avoid duplicates
            wrapper.onclick = null;
            
            // Set new event listener
            wrapper.onclick = (e) => {
                e.stopPropagation();
                
                if (!hasName || !name || name.trim() === '') {
                    // Try to find name from input
                    const rowIndex = parseInt(wrapper.dataset.rowIndex);
                    const nameInput = document.querySelector(`.name-input[data-index="${rowIndex}"]`);
                    
                    if (nameInput && nameInput.value.trim()) {
                        const actualName = nameInput.value.trim();
                        
                        // Update wrapper
                        wrapper.dataset.name = actualName;
                        wrapper.dataset.hasName = 'true';
                        wrapper.classList.remove('disabled');
                        
                        // Update signature div
                        const signatureDiv = wrapper.querySelector('.signature');
                        if (signatureDiv) {
                            signatureDiv.dataset.name = actualName;
                        }
                        
                        // Show modal
                        showSignatureModal(actualName);
                    } else {
                        alert(`Please enter a name for number ${displayNumber} first!`);
                        
                        // Focus on the name input
                        if (nameInput) {
                            nameInput.focus();
                            nameInput.select();
                        }
                    }
                    return;
                }
                
                showSignatureModal(name);
            };
            
            // Update visual indicators
            if (!hasName || !name || name.trim() === '') {
                wrapper.classList.add('disabled');
                wrapper.style.cursor = 'not-allowed';
                wrapper.title = `Enter a name for number ${displayNumber} first`;
                
                // Gray out the signature number
                const signatureNumber = wrapper.querySelector('.signature-number');
                if (signatureNumber) {
                    signatureNumber.style.opacity = '0.5';
                    signatureNumber.style.color = '#999';
                }
            } else {
                wrapper.classList.remove('disabled');
                wrapper.style.cursor = 'none';
                wrapper.title = `Click to add/edit signature for ${name}`;
                
                // Restore signature number appearance
                const signatureNumber = wrapper.querySelector('.signature-number');
                if (signatureNumber) {
                    signatureNumber.style.opacity = '1';
                    signatureNumber.style.color = '';
                }
            }
        });
        
        // Update keterangan indicators
        document.querySelectorAll('.keterangan').forEach(select => {
            const name = select.dataset.name || '';
            const index = parseInt(select.dataset.index);
            const nameInput = document.querySelector(`.name-input[data-index="${index}"]`);
            const hasName = nameInput && nameInput.value.trim() !== '';
            
            if (!hasName || !name || name.trim() === '') {
                select.disabled = true;
                select.style.cursor = 'not-allowed';
                select.style.backgroundColor = '';
                select.title = 'Enter a name first';
            } else {
                select.disabled = false;
                select.style.cursor = '';
                select.style.backgroundColor = '';
                select.title = `Select keterangan for ${name}`;
            }
        });
    }

    // ========== SIGNATURE MODAL FUNCTION ==========
    function showSignatureModal(name) {
        console.log(`Opening signature modal for ${currentDivision}_${currentGender}:`, name);
        
        if (!window.SignaturePad) {
            console.error('SignaturePad library not loaded!');
            alert('Signature feature requires SignaturePad library. Please check your internet connection.');
            return;
        }
        
        // Check if name already has saved signature
        const divisionKey = getFullDivisionKey('spreadsheetData');
        const data = JSON.parse(localStorage.getItem(divisionKey)) || {};
        const hasExistingSignature = data[name] && data[name].image;
        
        // Create modal overlay
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay signature-modal-overlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        `;
        
        // Create modal content
        const modal = document.createElement('div');
        modal.className = 'signature-modal';
        modal.style.cssText = `
            background: white;
            border-radius: 10px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            animation: modalPop 0.3s ease;
        `;
        
        modal.innerHTML = `
    <button class="close-modal-btn" style="
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 24px;
        cursor: none;
        color: #666;
        z-index: 2;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    ">&times;</button>
    
    <h3 style="
        margin-top: 0;
        margin-bottom: 15px;
        color: var(--text);
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        text-align: center;
        padding-right: 30px;
    ">Signature for: <span style="color: var(--text)">${name}</span></h3>
    
    <div style="text-align: center; margin-bottom: 20px;">
        <div style="display: inline-flex; gap: 15px; background: #f8f9fa; padding: 8px 15px; border-radius: 20px; font-size: 13px;">
            <div style="display: flex; align-items: center; gap: 5px;">
                <span class="material-symbols-outlined" style="font-size: 16px; color: var(--text);">
                    groups
                </span>
                <span style="font-weight: 500;">Division:</span>
                <span style="color: var(--secondary); font-weight: 600;">${currentDivision}</span>
            </div>
            <div style="height: 20px; width: 1px; background: #ddd;"></div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <span class="material-symbols-outlined" style="font-size: 16px; color: var(--text);">
                    person
                </span>
                <span style="font-weight: 500;">Gender:</span>
                <span style="color: var(--secondary); font-weight: 600;">${currentGender}</span>
            </div>
        </div>
    </div>
    
    <div class="signature-form-container">
        <!-- Canvas for signature -->
        <div style="margin-bottom: 30px; position: relative;">
            <label style="
                display: block;
                margin-bottom: 10px;
                font-weight: 500;
                color: var(--text);
                font-family: 'Poppins', sans-serif;
                text-align: center;
            ">Draw your signature below:</label>
            
            <!-- Clear signature button positioned left of canvas -->
            <div style="
                position: absolute;
                left: 0;
                top: 50%;
                transform: translateY(-50%);
                z-index: 10;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            ">
                <button id="modal-clear-signature" style="
                    background: transparent;
                    border: none;
                    cursor: not-allowed;
                    font-family: 'Poppins', sans-serif;
                    transition: all 0.3s ease;
                    width: 40px;
                    height: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    opacity: 0.5;
                    pointer-events: none;
                    flex-shrink: 0;
                    border-radius: 50%;
                " title="Clear Canvas">
                    <span class="material-symbols-outlined" style="font-size: 24px; color: #666;">
                        backspace
                    </span>
                </button>
            </div>
            
            <canvas id="modal-signature-canvas" width="400" height="150" style="
                width: 100%;
                max-width: 400px;
                height: 200px;
                border: 1px solid #ddd;
                border-radius: 5px;
                background: transparent;
                cursor: crosshair;
                display: block;
                margin: 0 auto;
                transition: border-color 0.3s ease;
                margin-top: 15px;
            "></canvas>
            
            <p style="
                text-align: center;
                margin-top: 10px;
                color: #666;
                font-size: 12px;
                font-family: 'Poppins', sans-serif;
            ">
                <span class="material-symbols-outlined" style="font-size: 14px; vertical-align: middle;">
                    info
                </span>
                Signature auto-saves as you draw
            </p>
        </div>
        
        <!-- Existing signature preview (only show if signature exists) -->
        <div id="existing-signature-section" style="
            border-top: 2px solid #eee;
            padding-top: 20px;
            margin-top: 20px;
            display: ${hasExistingSignature ? 'block' : 'none'};
            position: relative;
        ">
            <p style="
                margin-bottom: 15px;
                font-weight: 600;
                color: var(--text);
                font-family: 'Poppins', sans-serif;
                text-align: center;
            ">Current Signature:</p>
            
            <!-- Delete button container -->
            <div id="delete-button-container" style="
                position: absolute;
                left: 0;
                top: 50%;
                transform: translateY(-50%);
                z-index: 10;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            ">
                <!-- Delete button will be inserted here -->
            </div>
            
            <!-- Signature container -->
            <div id="existing-signature-container" style="
                max-width: 250px;
                max-height: 120px;
                margin: 0 auto;
                padding: 10px;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                background: #fff;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
            ">
                <div id="existing-signature-img" style="
                    width: 100%;
                    height: 100%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                "></div>
            </div>
            
            <div style="text-align: center; margin-top: 10px;">
                <p style="
                    font-size: 11px;
                    color: #888;
                    font-family: 'Poppins', sans-serif;
                    margin: 5px 0;
                ">
                    <span class="material-symbols-outlined" style="font-size: 12px; vertical-align: middle;">
                        shield
                    </span>
                    This signature is saved only for ${currentDivision} ${currentGender}
                </p>
            </div>
        </div>
        
        <!-- Instructions section -->
        <div style="
            margin-top: 25px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        ">
            <p style="
                margin: 0;
                font-size: 12px;
                color: #666;
                font-family: 'Poppins', sans-serif;
                line-height: 1.5;
            ">
                <span class="material-symbols-outlined" style="font-size: 14px; vertical-align: middle; margin-right: 5px;">
                    lightbulb
                </span>
                <strong>Note:</strong> Signatures are separated by Division and Gender. 
                Changing to a different division or gender will load different signatures.
            </p>
        </div>
    </div>
`;
        
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        document.body.classList.add('modal-open');
        
        // Initialize signature pad
        const canvas = document.getElementById('modal-signature-canvas');
        let signaturePad;
        
        try {
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgba(255, 255, 255, 0)',
                penColor: 'rgb(51, 51, 51)',
                minWidth: 1.5,
                maxWidth: 3,
                throttle: 16,
                velocityFilterWeight: 0.7
            });
        } catch (error) {
            console.error('Error initializing SignaturePad:', error);
            alert('Error initializing signature pad. Please refresh the page.');
            closeSignatureModal();
            return;
        }
        
        // Function to update button states based on drawing
        function updateButtonStates() {
            const hasDrawing = !signaturePad.isEmpty();
            const clearBtn = document.getElementById('modal-clear-signature');
            
            if (hasDrawing) {
                clearBtn.style.opacity = '1';
                clearBtn.style.cursor = 'pointer';
                clearBtn.style.pointerEvents = 'auto';
                clearBtn.disabled = false;
                clearBtn.title = 'Clear Canvas';
            } else {
                clearBtn.style.opacity = '0.5';
                clearBtn.style.cursor = 'not-allowed';
                clearBtn.style.pointerEvents = 'none';
                clearBtn.disabled = true;
                clearBtn.title = 'Draw something to clear';
            }
        }
        
// Function to auto-save signature
let saveTimeout;
function autoSaveSignature() {
    if (!signaturePad.isEmpty()) {
        clearTimeout(saveTimeout);
        
        saveTimeout = setTimeout(() => {
            const signatureDataUrl = signaturePad.toDataURL('image/png');
            
            try {
                // Save to localStorage with division key
                let localData = JSON.parse(localStorage.getItem(divisionKey)) || {};
                if (!localData[name]) {
                    localData[name] = {};
                }
                localData[name].image = signatureDataUrl;
                // Keep existing keterangan if it exists
                if (data[name] && data[name].keterangan) {
                    localData[name].keterangan = data[name].keterangan;
                }
                localStorage.setItem(divisionKey, JSON.stringify(localData));
                
                // Save to Firebase if available
                if (window.dbManager && window.dbManager.isInitialized) {
                    window.dbManager.saveSignature(
                        name, 
                        signatureDataUrl, 
                        data[name]?.keterangan || ''
                    ).then(result => {
                        if (result.success) {
                            console.log(`âœ… Firebase: Signature saved for ${name}`);
                        } else {
                            console.warn(`âš ï¸ Firebase: Failed to save signature:`, result.error);
                        }
                    });
                }
                
                // Trigger events
                window.dispatchEvent(new StorageEvent('storage', {
                    key: divisionKey,
                    newValue: JSON.stringify(localData)
                }));
                
                window.dispatchEvent(new CustomEvent('signatureSaved'));
                window.dispatchEvent(new CustomEvent('storageUpdate'));
                
                // Update existing signature section
                updateExistingSignatureSection(signatureDataUrl);
                
                console.log(`âœ… Signature auto-saved for ${currentDivision}_${currentGender}:`, name);
                
            } catch (error) {
                console.error('Error auto-saving signature:', error);
            }
        }, 1000);
    }
}
        
        // Function to update existing signature section
        function updateExistingSignatureSection(signatureDataUrl) {
            const existingSection = document.getElementById('existing-signature-section');
            const existingImg = document.getElementById('existing-signature-img');
            
            if (!existingSection || !existingImg) return;
            
            existingSection.style.display = 'block';
            
            // Update the image
            existingImg.innerHTML = `
                <img src="${signatureDataUrl}" 
                     alt="Signature for ${name}" 
                     style="
                         max-width: 100%;
                         max-height: 100px;
                         object-fit: contain;
                         display: block;
                     ">
            `;
            
            // Ensure delete button exists
            if (!document.querySelector('#modal-delete-signature-icon')) {
                createDeleteButton();
            }
        }
        
        // Function to create delete button
        function createDeleteButton() {
            const deleteContainer = document.getElementById('delete-button-container');
            if (!deleteContainer) return;
            
            // Clear existing delete button
            deleteContainer.innerHTML = '';
            
            // Create delete button icon
            const deleteBtn = document.createElement('button');
            deleteBtn.id = 'modal-delete-signature-icon';
            deleteBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 20px;">delete</span>';
            deleteBtn.title = "Delete signature";
            deleteBtn.style.cssText = `
                background: transparent;
                border: none;
                cursor: none;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
                opacity: 0.7;
                width: 40px;
                height: 40px;
                border-radius: 50%;
            `;
            
            // Add hover effects for delete button
            deleteBtn.addEventListener('mouseenter', () => {
                deleteBtn.style.opacity = '1';
                deleteBtn.style.color = '#666';
            });
            
            deleteBtn.addEventListener('mouseleave', () => {
                deleteBtn.style.opacity = '0.7';
                deleteBtn.style.backgroundColor = 'transparent';
                deleteBtn.style.color = '#666';
            });
            
            // Add delete functionality - WITH AUTO-CLOSE
            deleteBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                if (!confirm(`Are you sure you want to delete the signature for "${name}"?`)) {
                    return;
                }
                
                // Disable button during deletion
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 20px;">hourglass_empty</span>';
                deleteBtn.style.cursor = 'wait';
                
                try {
                    // Delete from localStorage with division key
                    let localData = JSON.parse(localStorage.getItem(divisionKey)) || {};
                    if (localData[name]) {
                        // Remove only the image
                        delete localData[name].image;
                        
                        // If no keterangan either, remove the entire entry
                        if (!localData[name].keterangan) {
                            delete localData[name];
                        }
                        
                        localStorage.setItem(divisionKey, JSON.stringify(localData));
                    }
                    
                    // Delete from Firebase if available
                    if (window.dbManager) {
                        await window.dbManager.deleteSignature(name);
                    }
                    
                    // Trigger events
                    window.dispatchEvent(new StorageEvent('storage', {
                        key: divisionKey,
                        newValue: JSON.stringify(localData),
                        url: window.location.href
                    }));
                    
                    window.dispatchEvent(new CustomEvent('signatureDeleted'));
                    window.dispatchEvent(new CustomEvent('storageUpdate'));
                    
                    // CLOSE MODAL IMMEDIATELY AFTER SUCCESSFUL DELETION
                    closeSignatureModal();
                    
                    // Update the table display
                    if (typeof loadSignaturesAndKeterangan === 'function') {
                        loadSignaturesAndKeterangan();
                    }
                    
                    // Show global notification
                    if (typeof showNotification === 'function') {
                        showNotification('Signature deleted successfully!', 'success');
                    }
                    
                } catch (error) {
                    console.error('Error deleting signature:', error);
                    
                    // Restore delete button
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 20px;">delete</span>';
                    deleteBtn.style.cursor = 'none';
                    
                    alert('Error deleting signature. Please try again.');
                }
            });
            
            // Add delete button to the separate container
            deleteContainer.appendChild(deleteBtn);
        }
        
        // Load existing signature if it exists
        if (hasExistingSignature && data[name].image) {
            const existingImg = document.getElementById('existing-signature-img');
            existingImg.innerHTML = `
                <img src="${data[name].image}" 
                     alt="Existing signature for ${name}" 
                     style="
                         max-width: 100%;
                         max-height: 100px;
                         object-fit: contain;
                         display: block;
                     ">
            `;
            
            // Create delete button
            createDeleteButton();
        }
        
        // Event listeners
        const closeBtn = modal.querySelector('.close-modal-btn');
        closeBtn.addEventListener('click', closeSignatureModal);
        
        // Hover effect for close button
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.backgroundColor = 'transparent';
            closeBtn.style.color = '#333';
        });
        
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.backgroundColor = 'transparent';
            closeBtn.style.color = '#666';
        });
        
        // Close on overlay click
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                closeSignatureModal();
            }
        });
        
        // Close on Escape key
        const handleEscape = (e) => {
            if (e.key === 'Escape') {
                closeSignatureModal();
            }
        };
        document.addEventListener('keydown', handleEscape);
        
        // Clear signature button
        const clearBtn = document.getElementById('modal-clear-signature');
        clearBtn.addEventListener('click', () => {
            if (signaturePad && !signaturePad.isEmpty()) {
                signaturePad.clear();
                updateButtonStates();
            }
        });
        
        clearBtn.addEventListener('mouseenter', () => {
            if (!clearBtn.disabled) {
                clearBtn.style.opacity = '1';
                clearBtn.style.backgroundColor = 'rgba(0,0,0,0.05)';
            }
        });
        
        clearBtn.addEventListener('mouseleave', () => {
            if (!clearBtn.disabled) {
                clearBtn.style.opacity = '0.7';
                clearBtn.style.backgroundColor = 'transparent';
            }
        });
        
        // Canvas interaction listeners
        canvas.addEventListener('mousedown', () => {
            canvas.style.borderColor = 'var(--secondary)';
        });
        
        canvas.addEventListener('mouseup', () => {
            canvas.style.borderColor = '#ddd';
            updateButtonStates();
            autoSaveSignature();
        });
        
        canvas.addEventListener('touchend', () => {
            setTimeout(() => {
                updateButtonStates();
                autoSaveSignature();
            }, 100);
        });
        
        // Signature pad events
        signaturePad.onBegin = () => {
            canvas.style.borderColor = 'var(--secondary)';
        };
        
        signaturePad.onEnd = () => {
            canvas.style.borderColor = '#ddd';
            updateButtonStates();
            autoSaveSignature();
        };
        
        // Initialize button states
        updateButtonStates();
        
        // Resize canvas for high DPI displays
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext('2d').scale(ratio, ratio);
            if (signaturePad) {
                signaturePad.clear();
                updateButtonStates();
            }
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // Close modal function with animation
        function closeSignatureModal() {
            // Clear any pending save timeout
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            
            // Remove resize listener
            window.removeEventListener('resize', resizeCanvas);
            
            // Remove event listeners
            document.removeEventListener('keydown', handleEscape);
            
            // Animate modal out
            modal.style.animation = 'modalPopOut 0.3s ease forwards';
            overlay.style.animation = 'fadeOut 0.3s ease forwards';
            
            setTimeout(() => {
                if (overlay.parentNode) {
                    document.body.removeChild(overlay);
                    document.body.classList.remove('modal-open');
                    
                    // Trigger update of signatures in table
                    window.dispatchEvent(new CustomEvent('modalClosed'));
                }
            }, 300);
        }
    }

    // ========== DIVISION & GENDER MANAGEMENT ==========
    function updateDivisionUI() {
        const divisionSelect = document.getElementById('division-select');
        if (divisionSelect) {
            divisionSelect.value = currentDivision;
        }
        
        // Update page toggle label to show division
        const toggleLabel = document.getElementById('reportToggleLabel');
        if (toggleLabel) {
            if (displayMode === 'one-page') {
                toggleLabel.textContent = `All Names - ${currentDivision}`;
            } else {
                toggleLabel.textContent = `${currentDivision} - Page ${currentPage} of ${getTotalPages()}`;
            }
        }
    }
    
    function getTotalPages() {
        switch(displayMode) {
            case 'one-page': return 1;
            case 'two-page': return 2;
            case 'three-page': return 3;
            case 'four-page': return 4;
            case 'five-page': return 5;
            default: return 1;
        }
    }
    
    function changeDivision(newDivision) {
        if (newDivision === currentDivision) return;
        
        console.log(`Changing division from ${currentDivision} to ${newDivision}`);
        
        // Save current division data before switching
        saveDivisionData();
        
        // Update current division
        currentDivision = newDivision;
        localStorage.setItem('currentDivision', currentDivision);
        
        // Load new division data
        loadDivisionData();
        
        // Update UI
        updateDivisionUI();
        updateGenderUI();
        updateReportView();
        
        // Show notification
        showNotification(`Switched to ${currentDivision} division`, 'info');
        
        // Close dropdown
        document.getElementById('dropdown-menu').style.display = 'none';
        const overlay = document.querySelector('.dropdown-overlay');
        if (overlay) overlay.style.display = 'none';
    }
    
    function setupDivisionSelector() {
        const divisionSelect = document.getElementById('division-select');
        if (divisionSelect) {
            divisionSelect.value = currentDivision;
            
            divisionSelect.addEventListener('change', function() {
                changeDivision(this.value);
            });
        }
        
        updateDivisionUI();
    }

    function updateGenderUI() {
        const genderSelect = document.getElementById('gender-select');
        const genderSection = document.getElementById('gender-section');
        
        if (genderSelect) {
            genderSelect.value = currentGender;
        }
        
        // Always show gender section
        if (genderSection) {
            genderSection.style.display = 'block';
        }
        
        // Update page toggle label to show gender
        const toggleLabel = document.getElementById('reportToggleLabel');
        if (toggleLabel) {
            // Remove existing gender indicator
            const existingGenderIndicator = document.getElementById('gender-indicator');
            if (existingGenderIndicator) {
                existingGenderIndicator.remove();
            }
            
            // Add gender indicator
            const genderIndicator = document.createElement('span');
            genderIndicator.id = 'gender-indicator';
            genderIndicator.textContent = currentGender;
            genderIndicator.style.marginLeft = '4px';
            genderIndicator.style.padding = '2px 6px';
            genderIndicator.style.background = 'var(--text)';
            genderIndicator.style.color = 'white';
            genderIndicator.style.borderRadius = '3px';
            genderIndicator.style.fontSize = '11px';
            genderIndicator.style.fontWeight = '500';
            
            // Add it after division indicator or at the end
            const divisionIndicator = document.getElementById('division-indicator');
            if (divisionIndicator) {
                divisionIndicator.parentNode.insertBefore(genderIndicator, divisionIndicator.nextSibling);
            } else {
                toggleLabel.appendChild(genderIndicator);
            }
        }
    }

    function changeGender(newGender) {
        if (newGender === currentGender) return;
        
        console.log(`Changing gender from ${currentGender} to ${newGender}`);
        
        // Save current gender data before switching
        saveDivisionData();
        
        // Update current gender
        currentGender = newGender;
        localStorage.setItem('currentGender', currentGender);
        
        // Load new gender data
        loadDivisionData();
        
        // Update UI
        updateGenderUI();
        updateReportView();
        
        // Show notification
        showNotification(`Switched to ${currentGender}`, 'info');
    }

    function setupGenderSelector() {
        const genderSelect = document.getElementById('gender-select');
        if (genderSelect) {
            genderSelect.value = currentGender;
            
            genderSelect.addEventListener('change', function() {
                changeGender(this.value);
                
                // Close dropdown after selection
                setTimeout(() => {
                    document.getElementById('dropdown-menu').style.display = 'none';
                    const overlay = document.querySelector('.dropdown-overlay');
                    if (overlay) overlay.style.display = 'none';
                }, 300);
            });
        }
        
        updateGenderUI();
    }

    // ========== LOGIN MODAL FUNCTIONS ==========
    function showLoginModal() {
        console.log("ðŸ” Showing login modal");
        
        // Check if modal already exists
        if (document.getElementById('login-modal')) {
            document.getElementById('login-modal').classList.add('show');
            document.body.classList.add('modal-open');
            return;
        }
        
        // Create modal HTML
        const modalHTML = `
            <div id="login-modal" class="login-modal-overlay">
                <div class="login-modal">
                    <button class="login-close-btn">&times;</button>
                    
                    <div class="login-modal-content">
                        <h3>Login to Edit</h3>
                        <p class="firebase-login-subtitle">Login to edit titles, info, names, and keterangan</p>
                        
                        <div class="login-input-group">
                            <input type="email" id="login-email" 
                                   class="login-input" 
                                   placeholder="Email address"
                                   autocomplete="email">
                        </div>
                        
                        <div class="login-input-group">
                            <div class="login-password-container">
                                <input type="password" id="login-password" 
                                       class="login-input" 
                                       placeholder="Password"
                                       autocomplete="current-password">
                                <button type="button" class="show-password" id="show-password">
                                    <span class="material-symbols-outlined">visibility</span>
                                </button>
                            </div>
                        </div>
                        
                        <div id="login-error" class="login-error"></div>
                        
                        <div class="login-button-group">
                            <button id="modal-login-btn" class="login-btn">
                                Login
                            </button>
                            <button id="modal-register-btn" class="register-btn" disabled style="opacity: 0.5; cursor: not-allowed;">
                                Registration Disabled
                            </button>
                        </div>
                        
                        <div class="continue-offline">
                            <button id="modal-continue-btn" class="continue-btn">
                                Continue without login
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        document.body.classList.add('modal-open');
        
        // Get references
        const modal = document.getElementById('login-modal');
        const emailInput = document.getElementById('login-email');
        const passwordInput = document.getElementById('login-password');
        const showPasswordBtn = document.getElementById('show-password');
        const errorDiv = document.getElementById('login-error');
        
        // Show modal with animation
        setTimeout(() => {
            modal.classList.add('show');
            
            // Focus on email input
            setTimeout(() => {
                emailInput.focus();
            }, 300);
        }, 10);
        
        // Toggle password visibility
        showPasswordBtn.addEventListener('click', () => {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            
            // Change icon
            const icon = showPasswordBtn.querySelector('.material-symbols-outlined');
            icon.textContent = type === 'password' ? 'visibility' : 'visibility_off';
        });
        
        // Login button
        document.getElementById('modal-login-btn').addEventListener('click', async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            
            // Clear previous errors
            errorDiv.textContent = '';
            errorDiv.style.display = 'none';
            
            // Validation
            if (!email) {
                errorDiv.textContent = 'Please enter your email';
                errorDiv.style.display = 'block';
                emailInput.focus();
                return;
            }
            
            if (!password) {
                errorDiv.textContent = 'Please enter your password';
                errorDiv.style.display = 'block';
                passwordInput.focus();
                return;
            }
            
            // Show loading state
            const loginBtn = document.getElementById('modal-login-btn');
            const originalText = loginBtn.textContent;
            loginBtn.textContent = 'Logging in...';
            loginBtn.disabled = true;
            
            try {
                // Use Firebase auth if available, otherwise use simple auth
                let result;
                if (window.firebaseAuth) {
                    result = await window.firebaseAuth.login(email, password);
                } else {
                    // Simple local auth for demo
                    result = await simpleLogin(email, password);
                }
                
                if (result.success) {
                    // Success - close modal and update UI
                    closeLoginModal();
                    updateLoginUI(true, result.user || { email: email });
                    showNotification('Login successful! âœ…', 'success');
                } else {
                    // Show error
                    errorDiv.textContent = result.error;
                    errorDiv.style.display = 'block';
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            } catch (error) {
                errorDiv.textContent = 'An unexpected error occurred';
                errorDiv.style.display = 'block';
            } finally {
                // Restore button
                loginBtn.textContent = originalText;
                loginBtn.disabled = false;
            }
        });
        
        // Register button - show message that registration is disabled
        document.getElementById('modal-register-btn').addEventListener('click', async () => {
            errorDiv.textContent = 'Registration disabled. Only authorized users can login.';
            errorDiv.style.display = 'block';
            errorDiv.style.color = '#e74c3c';
        });
        
        // Continue without login
        document.getElementById('modal-continue-btn').addEventListener('click', () => {
            closeLoginModal();
            showNotification('Continuing in read-only mode ðŸ“±', 'info');
        });
        
        // Close button
        modal.querySelector('.login-close-btn').addEventListener('click', () => {
            closeLoginModal();
        });
        
        // Close on outside click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeLoginModal();
            }
        });
        
        // Close on Escape key
        const handleEscape = (e) => {
            if (e.key === 'Escape' && modal.classList.contains('show')) {
                closeLoginModal();
            }
        };
        document.addEventListener('keydown', handleEscape);
        
        // Enter key to submit
        const handleEnterKey = (e) => {
            if (e.key === 'Enter' && modal.classList.contains('show')) {
                if (emailInput === document.activeElement || passwordInput === document.activeElement) {
                    document.getElementById('modal-login-btn').click();
                }
            }
        };
        document.addEventListener('keydown', handleEnterKey);
        
        // Cleanup function
        modal.cleanup = () => {
            document.removeEventListener('keydown', handleEscape);
            document.removeEventListener('keydown', handleEnterKey);
        };
    }

// Update the simpleLogin function in the main JavaScript file
async function simpleLogin(email, password) {
    // Define allowed users with specific emails and passwords
    const allowedUsers = {
        'ami.smaitnh.2.0@gmail.com': '<!AMI 2.0>',
        'mps.smaitnh.2.0@gmail.com': 'MPS2',
        'osis.smaitnh.2.0@gmail.com': 'OSIS',
        'da.smaitnh.2.0@gmail.com': 'DA2'
    };
    
    console.log('ðŸ” Attempting simple login for:', email);
    
    // Check if email exists in allowed users
    if (allowedUsers[email]) {
        // Check if password matches
        if (password === allowedUsers[email]) {
            // Try Firebase login first if available
            if (window.firebaseAuth && window.firebaseAuth.isInitialized) {
                console.log('ðŸ”„ Trying Firebase login...');
                const firebaseResult = await window.firebaseAuth.login(email, password);
                
                if (firebaseResult.success) {
                    console.log('âœ… Firebase login successful');
                    
                    localStorage.setItem('currentUser', JSON.stringify({
                        email: email,
                        displayName: email.split('@')[0].replace(/\./g, ' ').replace('advanced ', ''),
                        isLoggedIn: true,
                        role: email.split('.')[1].toUpperCase()
                    }));
                    
                    return {
                        success: true,
                        user: {
                            email: email,
                            displayName: email.split('@')[0].replace(/\./g, ' ').replace('advanced ', ''),
                            role: email.split('.')[1].toUpperCase()
                        }
                    };
                } else {
                    console.log('âš ï¸ Firebase login failed:', firebaseResult.error);
                    // Fall back to local login
                }
            }
            
            // Local login (fallback)
            localStorage.setItem('currentUser', JSON.stringify({
                email: email,
                displayName: email.split('@')[0].replace(/\./g, ' ').replace('advanced ', ''),
                isLoggedIn: true,
                role: email.split('.')[1].toUpperCase()
            }));
            
            console.log('âœ… Local login successful');
            
            return {
                success: true,
                user: {
                    email: email,
                    displayName: email.split('@')[0].replace(/\./g, ' ').replace('advanced ', ''),
                    role: email.split('.')[1].toUpperCase()
                }
            };
        } else {
            console.log('âŒ Invalid password for:', email);
            return { success: false, error: 'Invalid password' };
        }
    }
    
    console.log('âŒ Email not authorized:', email);
    return { success: false, error: 'Email not authorized' };
}

    function closeLoginModal() {
        const modal = document.getElementById('login-modal');
        if (modal) {
            // Run cleanup if exists
            if (modal.cleanup) {
                modal.cleanup();
            }
            
            // Remove with animation
            modal.classList.remove('show');
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.remove();
                    document.body.classList.remove('modal-open');
                }
            }, 300);
        }
    }

    // Update login UI
    function updateLoginUI(isLoggedIn, userInfo = null) {
        const loginButton = document.querySelector('#dropdown-login-button');
        const body = document.body;
        
        if (isLoggedIn && userInfo) {
            // Update dropdown button
            if (loginButton) {
                loginButton.innerHTML = `
                    <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px; margin-right: 8px;">
                        logout
                    </span>
                    Logout
                    <div class="login-user-info">${userInfo.email || userInfo.displayName}</div>
                `;
                loginButton.classList.add('logged-in');
                loginButton.onclick = handleLogout;
            }
            
            // Add logged-in class to body
            body.classList.add('user-logged-in');
            
            // Enable editing of inputs
            enableInputEditing(true);
            
            // Save login state
            localStorage.setItem('userLoggedIn', 'true');
            if (userInfo) {
                localStorage.setItem('userInfo', JSON.stringify(userInfo));
            }
            
        } else {
            // Update dropdown button
            if (loginButton) {
                loginButton.innerHTML = `
                    <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 18px; margin-right: 8px;">
                        login
                    </span>
                    Login
                `;
                loginButton.classList.remove('logged-in');
                loginButton.onclick = showLoginModal;
            }
            
            // Remove logged-in class from body
            body.classList.remove('user-logged-in');
            
            // Disable editing of inputs
            enableInputEditing(false);
            
            // Clear login state
            localStorage.removeItem('userLoggedIn');
            localStorage.removeItem('userInfo');
        }
    }

    // Handle logout
    function handleLogout() {
        // Clear any Firebase auth
        if (window.firebaseAuth && window.firebaseAuth.logout) {
            window.firebaseAuth.logout();
        }
        
        // Clear local auth
        localStorage.removeItem('currentUser');
        
        // Update UI
        updateLoginUI(false);
        
        // Close dropdown
        document.getElementById('dropdown-menu').style.display = 'none';
        const overlay = document.querySelector('.dropdown-overlay');
        if (overlay) overlay.style.display = 'none';
        
        showNotification('Logged out successfully', 'info');
    }

    // Enable/disable input editing
    function enableInputEditing(enabled) {
        const titleInputs = document.querySelectorAll('.title-input');
        const infoInputs = document.querySelectorAll('.info-input');
        const nameInputs = document.querySelectorAll('.name-input');
        const dateInput = document.querySelector('.date-input');
        
        if (enabled) {
            // Enable editing
            titleInputs.forEach(input => {
                input.disabled = false;
                input.style.cursor = 'text';
                input.style.backgroundColor = 'transparent';
            });
            
            infoInputs.forEach(input => {
                input.disabled = false;
                input.style.cursor = 'text';
                input.style.backgroundColor = 'transparent';
            });
            
            nameInputs.forEach(input => {
                input.disabled = false;
                input.style.cursor = 'text';
                input.style.backgroundColor = 'transparent';
            });
            
            if (dateInput) {
                dateInput.disabled = false;
                dateInput.style.cursor = 'text';
                dateInput.style.backgroundColor = 'transparent';
            }
        } else {
            // Disable editing (but keep signatures enabled)
            titleInputs.forEach(input => {
                input.disabled = true;
                input.style.cursor = 'not-allowed';
                if (!input.matches(':focus')) {
                    input.style.backgroundColor = 'transparent';
                }
            });
            
            infoInputs.forEach(input => {
                input.disabled = true;
                input.style.cursor = 'not-allowed';
                if (!input.matches(':focus')) {
                    input.style.backgroundColor = 'transparent';
                }
            });
            
            nameInputs.forEach(input => {
                input.disabled = true;
                input.style.cursor = 'not-allowed';
                if (!input.matches(':focus')) {
                    input.style.backgroundColor = 'transparent';
                }
            });
            
            if (dateInput) {
                dateInput.disabled = true;
                dateInput.style.cursor = 'not-allowed';
                if (!dateInput.matches(':focus')) {
                    dateInput.style.backgroundColor = 'transparent';
                }
            }
        }
    }

    // Check login status on page load
    function checkLoginStatus() {
        const isLoggedIn = localStorage.getItem('userLoggedIn') === 'true';
        let userInfo = null;
        
        try {
            userInfo = JSON.parse(localStorage.getItem('userInfo') || 'null');
        } catch (e) {
            console.log('No valid user info found');
        }
        
        // Check Firebase auth if available
        if (window.firebaseAuth && window.firebaseAuth.isLoggedIn && window.firebaseAuth.getUserProfile) {
            const firebaseLoggedIn = window.firebaseAuth.isLoggedIn();
            if (firebaseLoggedIn && !isLoggedIn) {
                // Firebase user is logged in but our local state isn't set
                const profile = window.firebaseAuth.getUserProfile();
                updateLoginUI(true, profile);
                return;
            }
        }
        
        updateLoginUI(isLoggedIn, userInfo);
    }

    // ========== EVENT LISTENERS SETUP ==========
    function setupHamburgerMenu() {
        hamburgerMenu.addEventListener('click', (e) => {
            e.stopPropagation();
            const isVisible = dropdownMenu.style.display === 'block';
            dropdownMenu.style.display = isVisible ? 'none' : 'block';
            
            let overlay = document.querySelector('.dropdown-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'dropdown-overlay';
                document.body.appendChild(overlay);
            }
            overlay.style.display = isVisible ? 'none' : 'block';
            
            // Update division selector value when opening dropdown
            if (!isVisible) {
                const divisionSelect = document.getElementById('division-select');
                if (divisionSelect) {
                    divisionSelect.value = currentDivision;
                }
            }
        });

        document.querySelectorAll('.dropdown-item:not(.login-button):not(.dropdown-section)').forEach(item => {
            item.addEventListener('click', () => {
                const value = item.getAttribute('data-value');
                const validModes = ['one-page', 'two-page', 'three-page', 'four-page', 'five-page'];
                
                if (validModes.includes(value)) {
                    currentPage = '1';
                    localStorage.setItem('currentPage', currentPage);
                    
                    displayMode = value;
                    localStorage.setItem('displayMode', displayMode);
                    updateReportView();
                    
                    dropdownMenu.style.display = 'none';
                    document.querySelector('.dropdown-overlay').style.display = 'none';
                    
                    window.dispatchEvent(new CustomEvent('displayModeChange', { 
                        detail: { 
                            mode: displayMode,
                            page: parseInt(currentPage)
                        } 
                    }));
                }
            });
        });

        // Add login button listener
        const loginButton = document.querySelector('#dropdown-login-button');
        if (loginButton) {
            // Set initial click handler
            if (loginButton.classList.contains('logged-in')) {
                loginButton.onclick = handleLogout;
            } else {
                loginButton.onclick = showLoginModal;
            }
            
            loginButton.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdownMenu.style.display = 'none';
                const overlay = document.querySelector('.dropdown-overlay');
                if (overlay) overlay.style.display = 'none';
            });
        }

        document.addEventListener('click', (e) => {
            if (!hamburgerMenu.contains(e.target) && !dropdownMenu.contains(e.target)) {
                dropdownMenu.style.display = 'none';
                const overlay = document.querySelector('.dropdown-overlay');
                if (overlay) overlay.style.display = 'none';
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                dropdownMenu.style.display = 'none';
                const overlay = document.querySelector('.dropdown-overlay');
                if (overlay) overlay.style.display = 'none';
            }
        });
    }
    
    function initializeButtonPositions() {
        if (hamburgerMenu) {
            hamburgerMenu.style.position = 'fixed';
            hamburgerMenu.style.top = '15px';
            hamburgerMenu.style.right = '20px';
            hamburgerMenu.style.zIndex = '1001';
        }

        if (dropdownMenu) {
            dropdownMenu.style.position = 'fixed';
            dropdownMenu.style.top = '60px';
            dropdownMenu.style.right = '20px';
            dropdownMenu.style.zIndex = '1002';
        }
    }

    function attachEventListeners() {
        // Signature click events
        document.querySelectorAll('.signature-wrapper').forEach(wrapper => {
            wrapper.onclick = (e) => {
                e.stopPropagation();
                
                // Get data from wrapper
                const name = wrapper.dataset.name || '';
                const displayNumber = wrapper.dataset.displayNumber;
                const hasName = wrapper.dataset.hasName === 'true';
                const rowIndex = parseInt(wrapper.dataset.rowIndex);
                
                // If no name exists, check if we can get it from the corresponding input
                if (!hasName || !name || name.trim() === '') {
                    // Find the name input for this row index
                    const nameInput = document.querySelector(`.name-input[data-index="${rowIndex}"]`);
                    if (nameInput && nameInput.value.trim()) {
                        const actualName = nameInput.value.trim();
                        
                        // Update the wrapper with the actual name
                        wrapper.dataset.name = actualName;
                        wrapper.dataset.hasName = 'true';
                        wrapper.classList.remove('disabled');
                        
                        // Update the signature div
                        const signatureDiv = wrapper.querySelector('.signature');
                        if (signatureDiv) {
                            signatureDiv.dataset.name = actualName;
                        }
                        
                        // Enable keterangan for this name
                        const keteranganSelect = document.querySelector(`.keterangan[data-index="${rowIndex}"]`);
                        if (keteranganSelect) {
                            keteranganSelect.disabled = false;
                            keteranganSelect.dataset.name = actualName;
                        }
                        
                        // Save the name
                        saveNameAtIndex(rowIndex, actualName);
                        
                        // Show signature modal - always enabled even without login
                        showSignatureModal(actualName);
                        return;
                    } else {
                        alert(`Please enter a name for number ${displayNumber} first!`);
                        
                        // Focus on the corresponding name input
                        if (nameInput) {
                            const isLoggedIn = document.body.classList.contains('user-logged-in');
                            if (isLoggedIn) {
                                nameInput.focus();
                                nameInput.select();
                            } else {
                                showNotification('Please login to enter names', 'warning');
                                setTimeout(() => {
                                    showLoginModal();
                                }, 500);
                            }
                        }
                        return;
                    }
                }
                
                // Show signature modal - always enabled even without login
                showSignatureModal(name);
            };
        });
        
        // Keterangan change event
        document.querySelectorAll('.keterangan').forEach(select => {
            select.addEventListener('change', function() {
                const name = this.dataset.name;
                const value = this.value;
                
                if (name && name.trim() !== '') {
                    console.log(`Keterangan changed for "${name}": "${value}"`);
                    saveKeterangan(name, value);
                }
            });
            
            // Save on blur as well
            select.addEventListener('blur', function() {
                const name = this.dataset.name;
                const value = this.value;
                
                if (name && name.trim() !== '') {
                    saveKeterangan(name, value);
                }
            });
        });
        
        // Name input event handling
        document.querySelectorAll('.name-input').forEach(input => {
            // Remove existing event listeners to avoid duplicates
            const newInput = input.cloneNode(true);
            input.parentNode.replaceChild(newInput, input);
        });
        
        // Re-attach event listeners to all name inputs
        document.querySelectorAll('.name-input').forEach(input => {
            input.addEventListener('click', function(e) {
                e.preventDefault();
                this.focus();
                
                if (!this.value.trim()) {
                    this.select();
                } else {
                    const length = this.value.length;
                    this.setSelectionRange(length, length);
                }
            });
            
            input.addEventListener('focus', function(e) {
                const isLoggedIn = document.body.classList.contains('user-logged-in');
                if (!isLoggedIn) {
                    showNotification('Please login to edit names', 'warning');
                    this.blur();
                    
                    // Show login modal after a short delay
                    setTimeout(() => {
                        showLoginModal();
                    }, 500);
                    
                    e.preventDefault();
                    return false;
                }
                
                if (this.value.trim()) {
                    const length = this.value.length;
                    this.setSelectionRange(length, length);
                }
            });
            
            input.addEventListener('change', function(e) {
                const index = parseInt(this.dataset.index);
                const newName = this.value.trim();
                saveNameAtIndex(index, newName);
                updateSignatureAndKeteranganForIndex(index, newName);
            });
            
            input.addEventListener('blur', function(e) {
                const index = parseInt(this.dataset.index);
                const newName = this.value.trim();
                saveNameAtIndex(index, newName);
                updateSignatureAndKeteranganForIndex(index, newName);
                this.style.backgroundColor = 'transparent';
                this.style.outline = 'none';
            });
            
            input.addEventListener('keydown', function(e) {
                const currentIndex = parseInt(this.dataset.index);
                const currentValue = this.value.trim();
                
                if (e.key === 'Enter' || e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                    e.preventDefault();
                    
                    if (currentValue !== rowHeaderNames[currentIndex]) {
                        saveNameAtIndex(currentIndex, currentValue);
                        updateSignatureAndKeteranganForIndex(currentIndex, currentValue);
                    }
                    
                    const allNameInputs = Array.from(document.querySelectorAll('.name-input'))
                        .sort((a, b) => parseInt(a.dataset.index) - parseInt(b.dataset.index));
                    
                    const currentPos = allNameInputs.findIndex(inp => 
                        parseInt(inp.dataset.index) === currentIndex
                    );
                    
                    let nextInput = null;
                    if (currentPos < allNameInputs.length - 1) {
                        nextInput = allNameInputs[currentPos + 1];
                    } else {
                        const lastIndex = rowHeaderNames.length;
                        saveNameAtIndex(lastIndex, '');
                        generateTableRows();
                        
                        setTimeout(() => {
                            const newInputElem = document.querySelector(`.name-input[data-index="${lastIndex}"]`);
                            if (newInputElem) {
                                newInputElem.focus();
                                newInputElem.select();
                            }
                        }, 10);
                        return;
                    }
                    
                    if (nextInput) {
                        nextInput.focus();
                        
                        if (!nextInput.value.trim()) {
                            nextInput.select();
                        } else {
                            const length = nextInput.value.length;
                            nextInput.setSelectionRange(length, length);
                        }
                    }
                }
                
                if (e.key === 'Tab' && !e.shiftKey) {
                    e.preventDefault();
                    
                    if (currentValue !== rowHeaderNames[currentIndex]) {
                        saveNameAtIndex(currentIndex, currentValue);
                        updateSignatureAndKeteranganForIndex(currentIndex, currentValue);
                    }
                    
                    const currentRow = this.closest('tr');
                    if (currentRow) {
                        const keteranganSelect = currentRow.querySelector('.keterangan');
                        if (keteranganSelect) {
                            // Enable keterangan if name exists
                            if (currentValue.trim()) {
                                keteranganSelect.disabled = false;
                                keteranganSelect.dataset.name = currentValue;
                            }
                            keteranganSelect.focus();
                        }
                    }
                }
                
                if (e.key === 'ArrowLeft' || e.key === 'ArrowUp' || (e.key === 'Tab' && e.shiftKey)) {
                    e.preventDefault();
                    
                    if (currentValue !== rowHeaderNames[currentIndex]) {
                        saveNameAtIndex(currentIndex, currentValue);
                        updateSignatureAndKeteranganForIndex(currentIndex, currentValue);
                    }
                    
                    const allNameInputs = Array.from(document.querySelectorAll('.name-input'))
                        .sort((a, b) => parseInt(a.dataset.index) - parseInt(b.dataset.index));
                    
                    const currentPos = allNameInputs.findIndex(inp => 
                        parseInt(inp.dataset.index) === currentIndex
                    );
                    
                    if (currentPos > 0) {
                        const prevInput = allNameInputs[currentPos - 1];
                        prevInput.focus();
                        
                        if (!prevInput.value.trim()) {
                            prevInput.select();
                        } else {
                            const length = prevInput.value.length;
                            prevInput.setSelectionRange(length, length);
                        }
                    }
                }
            });
            
            input.addEventListener('dblclick', function(e) {
                e.preventDefault();
                this.select();
            });
        });
        
        // Re-attach keterangan event listeners
        document.querySelectorAll('.keterangan').forEach(select => {
            const newSelect = select.cloneNode(true);
            select.parentNode.replaceChild(newSelect, select);
        });
        
        document.querySelectorAll('.keterangan').forEach(select => {
            select.addEventListener('change', function() {
                const name = this.dataset.name;
                if (name && name.trim() !== '') {
                    saveKeterangan(name, this.value);
                }
            });
            
            select.addEventListener('blur', function() {
                const name = this.dataset.name;
                if (name && name.trim() !== '') {
                    saveKeterangan(name, this.value);
                }
            });
            
            select.addEventListener('keydown', function(e) {
                const name = this.dataset.name;
                const index = parseInt(this.dataset.index);
                
                if (name && name.trim() !== '') {
                    saveKeterangan(name, this.value);
                }
                
                if (e.key === 'Enter' || e.key === 'Tab' || e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                    e.preventDefault();
                    
                    const nameInput = document.querySelector(`.name-input[data-index="${index}"]`);
                    if (nameInput) {
                        const currentIndex = parseInt(nameInput.dataset.index);
                        
                        const allNameInputs = Array.from(document.querySelectorAll('.name-input'))
                            .sort((a, b) => parseInt(a.dataset.index) - parseInt(b.dataset.index));
                        
                        const currentPos = allNameInputs.findIndex(inp => 
                            parseInt(inp.dataset.index) === currentIndex
                        );
                        
                        let nextInput = null;
                        if (currentPos < allNameInputs.length - 1) {
                            nextInput = allNameInputs[currentPos + 1];
                        } else {
                            const lastIndex = rowHeaderNames.length;
                            saveNameAtIndex(lastIndex, '');
                            generateTableRows();
                            
                            setTimeout(() => {
                                const newInputElem = document.querySelector(`.name-input[data-index="${lastIndex}"]`);
                                if (newInputElem) {
                                    newInputElem.focus();
                                    newInputElem.select();
                                }
                            }, 10);
                            return;
                        }
                        
                        if (nextInput) {
                            nextInput.focus();
                            if (!nextInput.value.trim()) {
                                nextInput.select();
                            } else {
                                const length = nextInput.value.length;
                                nextInput.setSelectionRange(length, length);
                            }
                        }
                    }
                }
                
                if (e.key === 'ArrowLeft' || e.key === 'ArrowUp' || (e.key === 'Tab' && e.shiftKey)) {
                    e.preventDefault();
                    
                    const nameInput = document.querySelector(`.name-input[data-index="${index}"]`);
                    if (nameInput) {
                        nameInput.focus();
                        const length = nameInput.value.length;
                        nameInput.setSelectionRange(length, length);
                    }
                }
            });
        });
        
        setupInfoInputListeners();
        setupTitleInputListeners();
        setupDateInputListeners();
    }
    
    function setupInfoInputListeners() {
        const waktuInput = document.getElementById('waktu-input');
        const tempatInput = document.getElementById('tempat-input');
        const keteranganInput = document.getElementById('keterangan-input');
        
        if (waktuInput) {
            waktuInput.addEventListener('focus', function(e) {
                const isLoggedIn = document.body.classList.contains('user-logged-in');
                if (!isLoggedIn) {
                    showNotification('Please login to edit information', 'warning');
                    this.blur();
                    
                    setTimeout(() => {
                        showLoginModal();
                    }, 500);
                    
                    e.preventDefault();
                    return false;
                }
            });
            
            waktuInput.addEventListener('change', saveAttendanceInfo);
            waktuInput.addEventListener('blur', saveAttendanceInfo);
        }
        
        if (tempatInput) {
            tempatInput.addEventListener('focus', function(e) {
                const isLoggedIn = document.body.classList.contains('user-logged-in');
                if (!isLoggedIn) {
                    showNotification('Please login to edit information', 'warning');
                    this.blur();
                    
                    setTimeout(() => {
                        showLoginModal();
                    }, 500);
                    
                    e.preventDefault();
                    return false;
                }
            });
            
            tempatInput.addEventListener('change', saveAttendanceInfo);
            tempatInput.addEventListener('blur', saveAttendanceInfo);
        }
        
        if (keteranganInput) {
            keteranganInput.addEventListener('focus', function(e) {
                const isLoggedIn = document.body.classList.contains('user-logged-in');
                if (!isLoggedIn) {
                    showNotification('Please login to edit information', 'warning');
                    this.blur();
                    
                    setTimeout(() => {
                        showLoginModal();
                    }, 500);
                    
                    e.preventDefault();
                    return false;
                }
            });
            
            keteranganInput.addEventListener('change', saveAttendanceInfo);
            keteranganInput.addEventListener('blur', saveAttendanceInfo);
        }
    }
    
    function setupTitleInputListeners() {
        const title1 = document.getElementById('report-title1');
        const title2 = document.getElementById('report-title2');
        const title3 = document.getElementById('report-title3');
        
        if (title1) {
            title1.addEventListener('focus', function(e) {
                const isLoggedIn = document.body.classList.contains('user-logged-in');
                if (!isLoggedIn) {
                    showNotification('Please login to edit titles', 'warning');
                    this.blur();
                    
                    setTimeout(() => {
                        showLoginModal();
                    }, 500);
                    
                    e.preventDefault();
                    return false;
                }
            });
            
            title1.addEventListener('change', saveReportTitles);
            title1.addEventListener('blur', saveReportTitles);
        }
        
        if (title2) {
            title2.addEventListener('focus', function(e) {
                const isLoggedIn = document.body.classList.contains('user-logged-in');
                if (!isLoggedIn) {
                    showNotification('Please login to edit titles', 'warning');
                    this.blur();
                    
                    setTimeout(() => {
                        showLoginModal();
                    }, 500);
                    
                    e.preventDefault();
                    return false;
                }
            });
            
            title2.addEventListener('change', saveReportTitles);
            title2.addEventListener('blur', saveReportTitles);
        }
        
        if (title3) {
            title3.addEventListener('focus', function(e) {
                const isLoggedIn = document.body.classList.contains('user-logged-in');
                if (!isLoggedIn) {
                    showNotification('Please login to edit titles', 'warning');
                    this.blur();
                    
                    setTimeout(() => {
                        showLoginModal();
                    }, 500);
                    
                    e.preventDefault();
                    return false;
                }
            });
            
            title3.addEventListener('change', saveReportTitles);
            title3.addEventListener('blur', saveReportTitles);
        }
    }
    
    function setupDateInputListeners() {
        const dateInput = document.querySelector('.date-input');
        if (dateInput) {
            dateInput.addEventListener('focus', function(e) {
                const isLoggedIn = document.body.classList.contains('user-logged-in');
                if (!isLoggedIn) {
                    showNotification('Please login to edit date', 'warning');
                    this.blur();
                    
                    setTimeout(() => {
                        showLoginModal();
                    }, 500);
                    
                    e.preventDefault();
                    return false;
                }
            });
            
            dateInput.addEventListener('change', function() {
                const dateValue = this.value;
                localStorage.setItem(getFullDivisionKey('tanggalPresensi'), dateValue);
            });
            
            dateInput.addEventListener('blur', function() {
                const dateValue = this.value;
                localStorage.setItem(getFullDivisionKey('tanggalPresensi'), dateValue);
            });
        }
    }

    // ========== EXTERNAL EVENT LISTENERS ==========
    window.addEventListener('syncPageChange', (event) => {
        if (displayMode !== 'one-page') {
            currentPage = event.detail.page.toString();
            localStorage.setItem('currentPage', currentPage);
            updateReportView();
        }
    });

    window.addEventListener('displayModeChange', (event) => {
        displayMode = event.detail.mode;
        localStorage.setItem('displayMode', displayMode);
        updateReportView();
    });
    
    window.addEventListener('signatureSaved', () => {
        loadSignaturesAndKeterangan();
    });
    
    window.addEventListener('storage', (event) => {
        if (event.key === 'currentPage') {
            const newPage = localStorage.getItem('currentPage');
            currentPage = newPage;
            updateReportView();
        } else if (event.key === 'displayMode') {
            displayMode = localStorage.getItem('displayMode') || 'two-page';
            updateReportView();
        } else if (event.key && (event.key.includes(currentDivision + '_' + currentGender) || 
                  event.key.includes(currentDivision + '_' + (currentGender === 'Ikhwan' ? 'Akhwat' : 'Ikhwan')))) {
            // Handle division-specific data changes
            if (event.key.includes('attendanceNames')) {
                loadAttendanceNames();
                generateTableRows();
            } else if (event.key.includes('reportTitles') || event.key.includes('attendanceInfo')) {
                loadTitles();
                loadAttendanceInfo();
            } else if (event.key.includes('tanggalPresensi')) {
                setDynamicDate();
            } else if (event.key.includes('spreadsheetData')) {
                loadSignaturesAndKeterangan();
            }
        } else if (event.key === 'currentDivision') {
            // Handle division change from other tabs
            const newDivision = localStorage.getItem('currentDivision') || 'Khusus';
            changeDivision(newDivision);
        } else if (event.key === 'currentGender') {
            // Handle gender change from other tabs
            const newGender = localStorage.getItem('currentGender') || 'Ikhwan';
            changeGender(newGender);
        }
    });
    
    window.addEventListener('namesUpdate', () => {
        console.log('Names updated event received');
        loadAttendanceNames();
        generateTableRows();
    });
    
    window.addEventListener('storageUpdate', () => {
        loadSignaturesAndKeterangan();
    });
    
    // Listen to Firebase auth state changes
    if (window.firebaseAuth) {
        window.addEventListener('authStateChanged', (event) => {
            const { user, isLoggedIn, profile } = event.detail;
            updateLoginUI(isLoggedIn, profile);
        });
    }

    // Save all keterangan before page unload
    window.addEventListener('beforeunload', () => {
        console.log('Saving all keterangan before unload...');
        document.querySelectorAll('.keterangan').forEach(select => {
            const name = select.dataset.name;
            const keterangan = select.value;
            if (name && name.trim() !== '') {
                saveKeterangan(name, keterangan);
            }
        });
    });

    // Setup auto-save for keterangan
    function setupKeteranganAutoSave() {
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('keterangan')) {
                const name = e.target.dataset.name;
                const keterangan = e.target.value;
                if (name && name.trim() !== '') {
                    saveKeterangan(name, keterangan);
                }
            }
        });
    }

    // ========== INITIALIZATION ==========
    function initializePage() {
        console.log('report.js: Initializing application');
        
        // Migrate old data first
        migrateOldData();
        
        // Setup gender selector FIRST
        setupGenderSelector();
        setupDivisionSelector();
        
        // Load division data
        loadDivisionData();
        
        if (rowHeaderNames.length === 0) {
            rowHeaderNames.push('');
            rowHeaderNames.push('');
            saveAttendanceNames();
        } else {
            cleanupTrailingEmptyPairs();
        }
        
        initializeButtonPositions();
        setupHamburgerMenu();
        updateReportView();
        updateActiveDropdownItem();
        checkLoginStatus();
        
        // Setup auto-save for keterangan
        setupKeteranganAutoSave();
        
        setTimeout(() => {
            initializeSwipeGestures();
            console.log('Swipe gestures ready');
            
            // Add modal CSS animations
            if (!document.querySelector('#modal-animations')) {
                const style = document.createElement('style');
                style.id = 'modal-animations';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    
                    @keyframes fadeOut {
                        from { opacity: 1; }
                        to { opacity: 0; }
                    }
                    
                    @keyframes modalPop {
                        from { transform: scale(0.9); opacity: 0; }
                        to { transform: scale(1); opacity: 1; }
                    }
                    
                    @keyframes modalPopOut {
                        from { transform: scale(1); opacity: 1; }
                        to { transform: scale(0.9); opacity: 0; }
                    }
                    
                    .signature-wrapper {
                        cursor: none;
                    }
                    
                    .material-symbols-outlined {
                        vertical-align: middle;
                    }
                    
                    /* Login modal styles */
                    .login-modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        animation: fadeIn 0.3s ease;
                    }
                    
                    .login-modal {
                        background: white;
                        border-radius: 10px;
                        padding: 30px;
                        width: 90%;
                        max-width: 500px;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                        position: relative;
                        animation: modalPop 0.3s ease;
                    }
                    
                    .login-modal.show {
                        display: block;
                    }
                    
                    .login-modal-content h3 {
                        margin-top: 0;
                        margin-bottom: 20px;
                        color: var(--text);
                        font-family: 'Poppins', sans-serif;
                        font-weight: 600;
                        text-align: center;
                    }
                    
                    .login-modal-content .firebase-login-subtitle {
                        text-align: center;
                        color: var(--text-light);
                        margin-bottom: 25px;
                        font-size: 14px;
                    }
                    
                    .login-input-group {
                        margin-bottom: 20px;
                    }
                    
                    .login-input {
                        width: 100%;
                        padding: 12px 15px;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        font-family: 'Poppins', sans-serif;
                        font-size: 14px;
                        transition: border-color 0.3s ease;
                    }
                    
                    .login-input:focus {
                        outline: none;
                        border-color: var(--secondary);
                    }
                    
                    .login-password-container {
                        position: relative;
                    }
                    
                    .show-password {
                        position: absolute;
                        right: 10px;
                        top: 50%;
                        transform: translateY(-50%);
                        background: none;
                        border: none;
                        cursor: none;
                        color: #666;
                        padding: 5px;
                    }
                    
                    .login-error {
                        color: #ff6b6b;
                        font-size: 13px;
                        margin: 10px 0;
                        padding: 8px 12px;
                        background: #fff5f5;
                        border-radius: 4px;
                        display: none;
                    }
                    
                    .login-button-group {
                        display: flex;
                        gap: 10px;
                        margin-bottom: 20px;
                    }
                    
                    .login-btn, .register-btn {
                        flex: 1;
                        padding: 12px;
                        border: none;
                        border-radius: 6px;
                        font-family: 'Poppins', sans-serif;
                        font-weight: 500;
                        cursor: none;
                        transition: all 0.3s ease;
                    }
                    
                    .login-btn {
                        background: var(--secondary);
                        color: white;
                    }
                    
                    .login-btn:active {
                        background: var(--secin);
                    }
                    
                    .register-btn {
                        background: #f0f0f0;
                        color: var(--text);
                    }
                    
                    .register-btn:active {
                        background: #e0e0e0;
                    }
                    
                    .continue-offline {
                        text-align: center;
                        margin-top: 20px;
                        padding-top: 20px;
                        border-top: 1px solid #eee;
                    }
                    
                    .continue-btn {
                        background: transparent;
                        border: 1px solid #ddd;
                        color: var(--text-light);
                        padding: 10px 20px;
                        border-radius: 6px;
                        cursor: none;
                        font-family: 'Poppins', sans-serif;
                        transition: all 0.3s ease;
                    }
                    
                    .continue-btn:active {
                        background: #f5f5f5;
                        border-color: #ccc;
                    }
                    
                    .login-close-btn {
                        position: absolute;
                        top: 15px;
                        right: 15px;
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: none;
                        color: #666;
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
.division-select {
width: 100%;
padding: 8px 12px;
border-radius: 4px;
background: white;
font-family: 'Poppins', sans-serif;
font-size: 13px;
color: var(--text);
cursor: none;
outline: none;
}
                    }
                    
                    /* Login status indicator in dropdown */
                    .dropdown-item.login-button.logged-in {
                        background: var(--secondary);
                        color: white;
                    }
                    
                    .login-user-info {
                        font-size: 12px;
                        opacity: 0.8;
                        margin-top: 3px;
                    }
                    
                    /* Style for login button in dropdown */
                    .login-button .material-symbols-outlined {
                        vertical-align: middle;
                        margin-right: 8px;
                    }
                    
                    /* Make login button positioned at bottom */
                    .dropdown-item.login-button {
                        margin-top: auto;
                        background: white;
                    }
                    
                    .dropdown-item.login-button:active {
                        background: var(--secondary);
                        color: white;
                    }
                    
                    /* Disabled input styles when not logged in */
                    body:not(.user-logged-in) .title-input:not(:focus),
                    body:not(.user-logged-in) .info-input:not(:focus),
                    body:not(.user-logged-in) .name-input:not(:focus),
                    body:not(.user-logged-in) .date-input:not(:focus) {
                        background-color: white;
                        cursor: not-allowed;
                        color: var(--text);
                    }
                    
                    /* Enable signature even when not logged in */
                    .signature-wrapper {
                        cursor: none !important;
                    }
                    
                    body.user-logged-in .title-input:not(:focus),
                    body.user-logged-in .info-input:not(:focus),
                    body.user-logged-in .name-input:not(:focus),
                    body.user-logged-in .date-input:not(:focus) {
                        background-color: white;
                        cursor: none;
                        color: var(--text);
                    }
                    
                    body.user-logged-in .date-input:not(:focus) {
                        font-weight: bold;
                    }
                    
                    body:not(.user-logged-in) .date-input:not(:focus) {
                        font-weight: bold;
                    }
                    
                    .dropdown-section {
                        padding: 12px 16px;
                        background: white;
                    }
                    
                    .dropdown-section-label {
                        font-size: 12px;
                        color: var(--text-light);
                        margin-bottom: 6px;
                        font-weight: 500;
                        font-family: 'Poppins', sans-serif;
                    }
                    
                    .division-toggle-group {
                        display: flex;
                        align-items: center;
                    }
                    
                    .division-select {
                        width: 100%;
                        padding: 8px 12px;
                        border-radius: 4px;
                        background: white;
                        font-family: 'Poppins', sans-serif;
                        font-size: 13px;
                        color: var(--text);
                        cursor: none;
                        outline: none;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Force load signatures and keterangan after a delay
            setTimeout(() => {
                loadSignaturesAndKeterangan();
            }, 1000);
        }, 500);
    }

    // Start initialization
    initializePage();
});

// ========== GLOBAL FUNCTIONS ==========
function simpleDownload() {
    console.log('Using simple download method...');
    
    // Clone the paper element to preserve original state
    const originalPaper = document.getElementById('print-paper');
    const clonedPaper = originalPaper.cloneNode(true);
    
    // Temporarily replace all input elements with their values as text
    replaceInputsWithText(clonedPaper);
    
    // Create temporary container
    const tempContainer = document.createElement('div');
    tempContainer.style.cssText = `
        position: fixed;
        top: -9999px;
        left: -9999px;
        width: 210mm;
        height: 297mm;
        padding: 20mm;
        background: white;
        z-index: -1;
    `;
    
    tempContainer.appendChild(clonedPaper);
    document.body.appendChild(tempContainer);
    
    // Hide UI elements temporarily
    const uiElements = document.querySelectorAll('#hamburger-menu, #download-paper, .page-toggle-section, .btn-hamburger-menu, .btn-download-paper, #fallback-download-btn');
    uiElements.forEach(el => el.style.visibility = 'hidden');
    
    // Take screenshot
    html2canvas(clonedPaper, {
        scale: 2,
        backgroundColor: '#ffffff',
        useCORS: true,
        logging: false,
        allowTaint: true
    }).then(canvas => {
        // Restore UI elements
        uiElements.forEach(el => el.style.visibility = 'visible');
        
        // Clean up temporary container
        document.body.removeChild(tempContainer);
        
        // Download as PNG
        const link = document.createElement('a');
        const currentDivision = localStorage.getItem('currentDivision') || 'Khusus';
        const currentGender = localStorage.getItem('currentGender') || 'Ikhwan';
        const dateStr = new Date().toISOString().slice(0, 10);
        link.download = `Presensi_${currentDivision}_${currentGender}_${dateStr}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        showNotification('âœ… Downloaded as PNG image', 'success');
    }).catch(error => {
        console.error('Simple download failed:', error);
        showNotification('âŒ Download failed. Please try again.', 'error');
        
        // Clean up on error
        uiElements.forEach(el => el.style.visibility = 'visible');
        if (tempContainer.parentNode) {
            document.body.removeChild(tempContainer);
        }
    });
}

// Helper function to replace inputs with text
function replaceInputsWithText(element) {
    // First get all current values from the ORIGINAL document
    const originalValues = {
        title1: document.getElementById('report-title1')?.value || '',
        title2: document.getElementById('report-title2')?.value || '',
        title3: document.getElementById('report-title3')?.value || '',
        waktu: document.getElementById('waktu-input')?.value || '',
        tempat: document.getElementById('tempat-input')?.value || '',
        keteranganInfo: document.getElementById('keterangan-input')?.value || '',
        date: document.querySelector('.date-input')?.value || ''
    };
    
    // Get all original name values
    const originalNameInputs = document.querySelectorAll('.name-input');
    const originalNames = {};
    originalNameInputs.forEach(input => {
        originalNames[input.dataset.index] = {
            value: input.value || '',
            placeholder: input.placeholder
        };
    });
    
    // Replace title inputs with actual values (show empty if no value)
    const titleInputs = element.querySelectorAll('.title-input');
    titleInputs.forEach((input, index) => {
        const span = document.createElement('span');
        let value = '';
        if (index === 0) value = originalValues.title1;
        else if (index === 1) value = originalValues.title2;
        else if (index === 2) value = originalValues.title3;
        
        span.textContent = value;
        span.style.cssText = `
            display: inline-block;
            width: 100%;
            font-family: 'Times New Roman', Times, serif;
            font-size: 14px;
            text-align: center;
            margin: 5px 0;
            min-height: 1.2em;
        `;
        input.parentNode.replaceChild(span, input);
    });
    
    // Replace info inputs with actual values (show empty if no value)
    const infoInputs = element.querySelectorAll('.info-input');
    infoInputs.forEach((input, index) => {
        const span = document.createElement('span');
        let value = '';
        if (input.id === 'waktu-input') value = originalValues.waktu;
        else if (input.id === 'tempat-input') value = originalValues.tempat;
        else if (input.id === 'keterangan-input') value = originalValues.keteranganInfo;
        
        span.textContent = value;
        span.style.cssText = `
            display: inline-block;
            font-family: 'Times New Roman', Times, serif;
            font-size: 14px;
            margin-left: 5px;
            min-height: 1.2em;
        `;
        input.parentNode.replaceChild(span, input);
    });
    
    // Replace date input with actual value (show empty if no value)
    const dateInput = element.querySelector('.date-input');
    if (dateInput) {
        const span = document.createElement('span');
        span.textContent = originalValues.date;
        span.style.cssText = `
            display: block;
            font-family: 'Times New Roman', Times, serif;
            font-size: 12px;
            text-align: center;
            width: 100%;
            min-height: 1.2em;
        `;
        dateInput.parentNode.replaceChild(span, dateInput);
    }
    
    // Replace name inputs with actual values - CRITICAL: Show row even if empty, but hide placeholder
    const nameInputs = element.querySelectorAll('.name-input');
    nameInputs.forEach((input) => {
        const span = document.createElement('span');
        const nameData = originalNames[input.dataset.index];
        const actualValue = nameData ? nameData.value : '';
        
        // Always show the span (to maintain table structure), but content depends on value
        span.textContent = actualValue;
        span.style.cssText = `
            display: inline-block;
            width: 100%;
            font-family: 'Times New Roman', Times, serif;
            font-size: 14px;
            padding: 2px 5px;
            min-height: 1.2em;
        `;
        span.dataset.index = input.dataset.index;
        span.dataset.hasContent = actualValue.trim() !== '';
        
        // If no content, make it invisible but keep the space
        if (!actualValue.trim()) {
            span.style.color = 'transparent';
            span.style.visibility = 'hidden';
        }
        
        input.parentNode.replaceChild(span, input);
    });
    
    // Process keterangan selects - hide if no name
    processKeteranganSelects(element);
    
    // Process signature cells - keep all visible
    processSignatureCells(element);
    
    // KEEP ALL ROWS VISIBLE - only modify content
    keepAllRowsVisible(element);
    
    // Re-number all rows (keep original numbering)
    renumberAllRows(element);
}

// Helper function to process keterangan selects
function processKeteranganSelects(element) {
    const keteranganSelects = element.querySelectorAll('.keterangan');
    
    keteranganSelects.forEach(select => {
        const index = select.dataset.index;
        
        // Find the corresponding name span
        const nameSpan = element.querySelector(`span[data-index="${index}"]`);
        const hasName = nameSpan && nameSpan.dataset.hasContent === 'true';
        
        // Also check if keterangan has value
        const hasKeteranganValue = select.value && select.value.trim() !== '';
        
        // Show keterangan only if there's a name AND keterangan value
        if (hasName && hasKeteranganValue) {
            // Keep it visible
            select.style.display = '';
            // Update the value display
            const valueDisplay = document.createElement('span');
            valueDisplay.textContent = select.value;
            valueDisplay.style.cssText = `
                display: inline-block;
                font-family: 'Times New Roman', Times, serif;
                font-size: 14px;
            `;
            select.parentNode.replaceChild(valueDisplay, select);
        } else {
            // Hide keterangan select and its number
            select.style.display = 'none';
            const keteranganNumber = select.previousElementSibling;
            if (keteranganNumber && keteranganNumber.classList.contains('keterangan-number')) {
                keteranganNumber.style.display = 'none';
            }
        }
    });
}

// Helper function to process signature cells - keep all visible
function processSignatureCells(element) {
    const signatureCells = element.querySelectorAll('td[rowspan="2"]');
    signatureCells.forEach(cell => {
        cell.style.display = '';
        cell.style.visibility = 'visible';
        
        // Also keep signature numbers visible
        const signatureNumbers = cell.querySelectorAll('.signature-number');
        signatureNumbers.forEach(num => {
            num.style.display = '';
            num.style.visibility = 'visible';
        });
    });
}

// Helper function to keep all rows visible
function keepAllRowsVisible(element) {
    const allRows = element.querySelectorAll('#report-table-body tr');
    allRows.forEach(row => {
        row.style.display = '';
        row.style.visibility = 'visible';
        row.style.height = '';
        row.style.overflow = '';
        
        // Keep all cells visible
        const cells = row.querySelectorAll('td');
        cells.forEach(cell => {
            cell.style.display = '';
            cell.style.visibility = 'visible';
        });
    });
}

// Helper function to renumber all rows
function renumberAllRows(element) {
    const tbody = element.querySelector('#report-table-body');
    if (!tbody) return;
    
    const allRows = Array.from(tbody.querySelectorAll('tr'));
    let pairNumber = 1;
    
    for (let i = 0; i < allRows.length; i += 2) {
        const row1 = allRows[i];
        const row2 = allRows[i + 1];
        
        if (!row1 || !row2) continue;
        
        // Update row numbers (1, 2, 3, 4...)
        const rowNumber1 = pairNumber;
        const rowNumber2 = pairNumber + 1;
        
        // Update first column numbers
        const numberCell1 = row1.querySelector('td:first-child');
        const numberCell2 = row2.querySelector('td:first-child');
        
        if (numberCell1) numberCell1.textContent = `${rowNumber1}.`;
        if (numberCell2) numberCell2.textContent = `${rowNumber2}.`;
        
        // Update signature numbers
        const signatureNumbers = row1.querySelectorAll('.signature-number');
        if (signatureNumbers.length >= 2) {
            signatureNumbers[0].textContent = `${rowNumber1}.`;
            signatureNumbers[1].textContent = `${rowNumber2}.`;
        }
        
        // Update keterangan numbers
        const keteranganNumbers1 = row1.querySelectorAll('.keterangan-number');
        const keteranganNumbers2 = row2.querySelectorAll('.keterangan-number');
        
        keteranganNumbers1.forEach(span => {
            span.textContent = `${rowNumber1}.`;
        });
        
        keteranganNumbers2.forEach(span => {
            span.textContent = `${rowNumber2}.`;
        });
        
        pairNumber += 2;
    }
}

// Updated simpleDownload function (keep as is, just uses the new helper functions)
function simpleDownload() {
    console.log('Using simple download method...');
    
    // Clone the paper element to preserve original state
    const originalPaper = document.getElementById('print-paper');
    const clonedPaper = originalPaper.cloneNode(true);
    
    // Temporarily replace all input elements with their values as text
    replaceInputsWithText(clonedPaper);
    
    // Create temporary container
    const tempContainer = document.createElement('div');
    tempContainer.style.cssText = `
        position: fixed;
        top: -9999px;
        left: -9999px;
        width: 210mm;
        height: 297mm;
        padding: 20mm;
        background: white;
        z-index: -1;
    `;
    
    tempContainer.appendChild(clonedPaper);
    document.body.appendChild(tempContainer);
    
    // Hide UI elements temporarily
    const uiElements = document.querySelectorAll('#hamburger-menu, #download-paper, .page-toggle-section, .btn-hamburger-menu, .btn-download-paper, #fallback-download-btn');
    uiElements.forEach(el => el.style.visibility = 'hidden');
    
    // Take screenshot
    html2canvas(clonedPaper, {
        scale: 2,
        backgroundColor: '#ffffff',
        useCORS: true,
        logging: false,
        allowTaint: true
    }).then(canvas => {
        // Restore UI elements
        uiElements.forEach(el => el.style.visibility = 'visible');
        
        // Clean up temporary container
        document.body.removeChild(tempContainer);
        
        // Download as PNG
        const link = document.createElement('a');
        const currentDivision = localStorage.getItem('currentDivision') || 'Khusus';
        const currentGender = localStorage.getItem('currentGender') || 'Ikhwan';
        const dateStr = new Date().toISOString().slice(0, 10);
        link.download = `Presensi_${currentDivision}_${currentGender}_${dateStr}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        showNotification('âœ… Downloaded as PNG image', 'success');
    }).catch(error => {
        console.error('Simple download failed:', error);
        showNotification('âŒ Download failed. Please try again.', 'error');
        
        // Clean up on error
        uiElements.forEach(el => el.style.visibility = 'visible');
        if (tempContainer.parentNode) {
            document.body.removeChild(tempContainer);
        }
    });
}

// Helper function to replace inputs with text
function replaceInputsWithText(element) {
    // First get all current values from the ORIGINAL document
    const originalValues = {
        title1: document.getElementById('report-title1')?.value || '',
        title2: document.getElementById('report-title2')?.value || '',
        title3: document.getElementById('report-title3')?.value || '',
        waktu: document.getElementById('waktu-input')?.value || '',
        tempat: document.getElementById('tempat-input')?.value || '',
        keteranganInfo: document.getElementById('keterangan-input')?.value || '',
        date: document.querySelector('.date-input')?.value || ''
    };
    
    // Get all original name values - THIS IS CRITICAL
    const originalNameInputs = document.querySelectorAll('.name-input');
    const originalNames = {};
    originalNameInputs.forEach(input => {
        const index = input.dataset.index;
        const value = input.value || '';
        originalNames[index] = {
            value: value,
            hasContent: value.trim() !== ''
        };
        console.log(`Original name [${index}]: "${value}"`);
    });
    
    // Also get original keterangan values
    const originalKeteranganSelects = document.querySelectorAll('.keterangan');
    const originalKeterangan = {};
    originalKeteranganSelects.forEach(select => {
        const index = select.dataset.index;
        const value = select.value || '';
        const name = select.dataset.name || '';
        originalKeterangan[index] = {
            value: value,
            name: name,
            hasValue: value.trim() !== ''
        };
    });
    
    // Also get original signature data
    const originalSignatures = {};
    document.querySelectorAll('.signature').forEach(sig => {
        const index = sig.dataset.index;
        if (sig.innerHTML.trim() !== '') {
            originalSignatures[index] = sig.innerHTML;
        }
    });
    
    // Replace title inputs with actual values
    const titleInputs = element.querySelectorAll('.title-input');
    titleInputs.forEach((input, index) => {
        const span = document.createElement('span');
        let value = '';
        if (index === 0) value = originalValues.title1;
        else if (index === 1) value = originalValues.title2;
        else if (index === 2) value = originalValues.title3;
        
        span.textContent = value;
        span.style.cssText = `
            display: inline-block;
            width: 100%;
            font-family: 'Times New Roman', Times, serif;
            font-size: 14px;
            text-align: center;
            margin: 5px 0;
            min-height: 1.2em;
        `;
        input.parentNode.replaceChild(span, input);
    });
    
    // Replace info inputs with actual values
    const infoInputs = element.querySelectorAll('.info-input');
    infoInputs.forEach((input, index) => {
        const span = document.createElement('span');
        let value = '';
        if (input.id === 'waktu-input') value = originalValues.waktu;
        else if (input.id === 'tempat-input') value = originalValues.tempat;
        else if (input.id === 'keterangan-input') value = originalValues.keteranganInfo;
        
        span.textContent = value;
        span.style.cssText = `
            display: inline-block;
            font-family: 'Times New Roman', Times, serif;
            font-size: 14px;
            margin-left: 5px;
            min-height: 1.2em;
        `;
        input.parentNode.replaceChild(span, input);
    });
    
    // Replace date input with actual value
    const dateInput = element.querySelector('.date-input');
    if (dateInput) {
        const span = document.createElement('span');
        span.textContent = originalValues.date;
        span.style.cssText = `
            display: block;
            font-family: 'Times New Roman', Times, serif;
            font-size: 12px;
            text-align: center;
            width: 100%;
            min-height: 1.2em;
        `;
        dateInput.parentNode.replaceChild(span, dateInput);
    }
    
    // DON'T replace name inputs here - we'll handle them in fixRowStructure
    
    // Preserve the original table structure
    preserveTableStructure(element);
    
    // Process table rows - Show pairs only if at least one has name
    processTablePairs(element, originalNames, originalKeterangan, originalSignatures);
    
    // Ensure signature numbers are visible
    ensureSignatureNumbersVisible(element);
}

// Preserve original table structure
function preserveTableStructure(element) {
    const table = element.querySelector('table');
    if (!table) return;
    
    // Ensure proper column structure
    const thead = table.querySelector('thead');
    if (thead) {
        const headerRows = thead.querySelectorAll('tr');
        if (headerRows.length >= 2) {
            // Keep original structure but update date
            const dateCell = headerRows[0].querySelector('th[colspan="3"]');
            if (dateCell) {
                const dateSpan = document.createElement('span');
                const originalDate = document.querySelector('.date-input')?.value || '';
                dateSpan.textContent = originalDate;
                dateSpan.style.cssText = `
                    font-family: 'Times New Roman', Times, serif;
                    font-size: 12px;
                    text-align: center;
                    display: block;
                    width: 100%;
                `;
                dateCell.innerHTML = '';
                dateCell.appendChild(dateSpan);
            }
        }
    }
}

// Process table pairs with the original data
function processTablePairs(element, originalNames, originalKeterangan, originalSignatures) {
    const allRows = Array.from(element.querySelectorAll('#report-table-body tr'));
    const rowPairs = [];
    
    // Group rows into pairs
    for (let i = 0; i < allRows.length; i += 2) {
        if (allRows[i] && allRows[i + 1]) {
            rowPairs.push([allRows[i], allRows[i + 1]]);
        }
    }
    
    // First, hide ALL rows initially
    allRows.forEach(row => {
        row.style.display = 'none';
    });
    
    // Track visible pairs
    let visiblePairCount = 0;
    
    // Show only pairs that have at least one name
    rowPairs.forEach((pair, pairIndex) => {
        const [row1, row2] = pair;
        
        // Check indices for this pair
        const index1 = pairIndex * 2;
        const index2 = (pairIndex * 2) + 1;
        
        // Check if this pair has any content
        const hasName1 = originalNames[index1] && originalNames[index1].hasContent;
        const hasName2 = originalNames[index2] && originalNames[index2].hasContent;
        const hasAnyContent = hasName1 || hasName2;
        
        // If this pair has at least one name, show the entire pair
        if (hasAnyContent) {
            // Show both rows of the pair
            row1.style.display = '';
            row2.style.display = '';
            
            // Fix the row structure with original data
            fixRowStructure(row1, row2, pairIndex + 1, originalNames, originalKeterangan, originalSignatures);
            
            visiblePairCount++;
        }
    });
    
    // If NO pairs have any names, show just the first pair as empty
    if (visiblePairCount === 0 && rowPairs.length > 0) {
        const firstPair = rowPairs[0];
        const [row1, row2] = firstPair;
        
        row1.style.display = '';
        row2.style.display = '';
        
        // Fix the row structure for the first pair
        fixRowStructure(row1, row2, 1, originalNames, originalKeterangan, originalSignatures);
    }
}

// Fix row structure with original data
function fixRowStructure(row1, row2, pairNumber, originalNames, originalKeterangan, originalSignatures) {
    // Get the row numbers
    const rowNumber1 = (pairNumber * 2) - 1;
    const rowNumber2 = pairNumber * 2;
    
    // Get the original indices
    const index1 = (pairNumber - 1) * 2;
    const index2 = ((pairNumber - 1) * 2) + 1;
    
    // Get original values
    const originalName1 = originalNames[index1];
    const originalName2 = originalNames[index2];
    const originalKeterangan1 = originalKeterangan[index1];
    const originalKeterangan2 = originalKeterangan[index2];
    const originalSignature1 = originalSignatures[index1];
    const originalSignature2 = originalSignatures[index2];
    
    console.log(`Pair ${pairNumber}: Index1=${index1}, Name1="${originalName1?.value}"`, 
                `Index2=${index2}, Name2="${originalName2?.value}"`);
    
    // Determine if we should show keterangan
    const showKeterangan1 = originalName1?.hasContent && originalKeterangan1?.hasValue;
    const showKeterangan2 = originalName2?.hasContent && originalKeterangan2?.hasValue;
    
    // Rebuild row1 (first row of the pair)
    row1.innerHTML = `
        <td style="text-align: center; background-color: #fff; width: 7%; font-size: 14px; border: 1px solid #000;">${rowNumber1}.</td>
        <td style="background-color: #fff; width: 32%; font-size: 14px; border: 1px solid #000;">
            <span class="name-span" style="display: inline-block; width: 100%; font-family: 'Times New Roman', Times, serif; font-size: 14px; padding: 2px 5px;">
                ${originalName1?.value || ''}
            </span>
        </td>
        <td rowspan="2" style="background-color: #fff; width: 15%; font-size: 14px; border: 1px solid #000;">
            <div class="signature-number" style="font-size: 14px; text-align: left; margin-bottom: 5px;">${rowNumber1}.</div>
            <div class="signature-wrapper" style="width: 100%; height: 50px; display: flex; align-items: center; justify-content: center; background-color: #fff; border: none; padding: 5px; box-sizing: border-box; margin-bottom: -5px;">
                <div class="signature" data-index="${index1}" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                    ${originalSignature1 || ''}
                </div>
            </div>
        </td>
        <td rowspan="2" style="background-color: #fff; width: 15%; font-size: 14px; border: 1px solid #000;">
            <div class="signature-number" style="font-size: 14px; text-align: left; margin-bottom: 5px;">${rowNumber2}.</div>
            <div class="signature-wrapper" style="width: 100%; height: 50px; display: flex; align-items: center; justify-content: center; background-color: #fff; border: none; padding: 5px; box-sizing: border-box; margin-bottom: -5px;">
                <div class="signature" data-index="${index2}" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                    ${originalSignature2 || ''}
                </div>
            </div>
        </td>
        <td style="background-color: #fff; width: 17%; font-size: 14px; border: 1px solid #000;">
            <div class="keterangan-container" style="display: flex; align-items: center; gap: 5px;">
                <span class="keterangan-number" style="font-size: 14px;">${rowNumber1}.</span>
                ${showKeterangan1 ? 
                    `<span style="font-family: 'Times New Roman', Times, serif; font-size: 14px;">${originalKeterangan1?.value || ''}</span>` : 
                    `<span style="font-family: 'Times New Roman', Times, serif; font-size: 14px;"> </span>`
                }
            </div>
        </td>
    `;
    
    // Rebuild row2 (second row of the pair)
    row2.innerHTML = `
        <td style="text-align: center; background-color: #fff; width: 7%; font-size: 14px; border: 1px solid #000;">${rowNumber2}.</td>
        <td style="background-color: #fff; width: 32%; font-size: 14px; border: 1px solid #000;">
            <span class="name-span" style="display: inline-block; width: 100%; font-family: 'Times New Roman', Times, serif; font-size: 14px; padding: 2px 5px;">
                ${originalName2?.value || ''}
            </span>
        </td>
        <td style="background-color: #fff; width: 17%; font-size: 14px; border: 1px solid #000;">
            <div class="keterangan-container" style="display: flex; align-items: center; gap: 5px;">
                <span class="keterangan-number" style="font-size: 14px;">${rowNumber2}.</span>
                ${showKeterangan2 ? 
                    `<span style="font-family: 'Times New Roman', Times, serif; font-size: 14px;">${originalKeterangan2?.value || ''}</span>` : 
                    `<span style="font-family: 'Times New Roman', Times, serif; font-size: 14px;"> </span>`
                }
            </div>
        </td>
    `;
    
    // Make empty names invisible
    const nameSpan1 = row1.querySelector('.name-span');
    const nameSpan2 = row2.querySelector('.name-span');
    
    if (nameSpan1 && (!originalName1?.hasContent || originalName1.value.trim() === '')) {
        nameSpan1.textContent = '';
        nameSpan1.style.color = 'transparent';
    }
    
    if (nameSpan2 && (!originalName2?.hasContent || originalName2.value.trim() === '')) {
        nameSpan2.textContent = '';
        nameSpan2.style.color = 'transparent';
    }
}

// Ensure signature numbers are always visible
function ensureSignatureNumbersVisible(element) {
    const allSignatureNumbers = element.querySelectorAll('.signature-number');
    allSignatureNumbers.forEach(span => {
        span.style.display = '';
        span.style.visibility = 'visible';
        span.style.opacity = '1';
        span.style.color = '#000000';
        span.style.fontSize = '14px';
        span.style.fontFamily = "'Times New Roman', Times, serif";
    });
    
    // Also ensure keterangan numbers are visible
    const allKeteranganNumbers = element.querySelectorAll('.keterangan-number');
    allKeteranganNumbers.forEach(span => {
        span.style.display = '';
        span.style.visibility = 'visible';
        span.style.opacity = '1';
        span.style.color = '#000000';
        span.style.fontSize = '14px';
        span.style.fontFamily = "'Times New Roman', Times, serif";
    });
}

// Helper function to renumber ONLY visible rows
function renumberVisibleRows(element) {
    const tbody = element.querySelector('#report-table-body');
    if (!tbody) return;
    
    // Get only visible rows
    const visibleRows = Array.from(tbody.querySelectorAll('tr'))
        .filter(row => row.style.display !== 'none');
    
    let rowNumber = 1;
    
    for (let i = 0; i < visibleRows.length; i += 2) {
        const row1 = visibleRows[i];
        const row2 = visibleRows[i + 1];
        
        if (!row1 || !row2) continue;
        
        // Update row numbers
        const numberCell1 = row1.querySelector('td:first-child');
        const numberCell2 = row2.querySelector('td:first-child');
        
        if (numberCell1) numberCell1.textContent = `${rowNumber}.`;
        if (numberCell2) numberCell2.textContent = `${rowNumber + 1}.`;
        
        // Update signature numbers (both in the same row1 cell)
        const signatureNumbers = row1.querySelectorAll('.signature-number');
        if (signatureNumbers.length >= 2) {
            signatureNumbers[0].textContent = `${rowNumber}.`;
            signatureNumbers[1].textContent = `${rowNumber + 1}.`;
        }
        
        // Update keterangan numbers
        const keteranganNumbers1 = row1.querySelectorAll('.keterangan-number');
        const keteranganNumbers2 = row2.querySelectorAll('.keterangan-number');
        
        keteranganNumbers1.forEach(span => {
            span.textContent = `${rowNumber}.`;
        });
        
        keteranganNumbers2.forEach(span => {
            span.textContent = `${rowNumber + 1}.`;
        });
        
        rowNumber += 2;
    }
}

// Call this during initialization
addFallbackDownloadButton();

// Fallback function dengan pengaturan lebih ringan
function downloadOptimizedFallback() {
    const paperElement = document.getElementById('print-paper');
    if (!paperElement) return;
    
    const clone = paperElement.cloneNode(true);
    
    // Buat div sementara
    const tempDiv = document.createElement('div');
    tempDiv.style.cssText = `
        position: absolute;
        left: -9999px;
        top: -9999px;
        width: 210mm;
        background: white;
        padding: 20mm;
    `;
    
    tempDiv.appendChild(clone);
    document.body.appendChild(tempDiv);
    
    // Convert langsung ke JPEG dengan kualitas rendah
    html2canvas(clone, {
        scale: 0.75,
        useCORS: true,
        backgroundColor: '#ffffff',
        logging: false
    }).then(canvas => {
        // Convert to JPEG dengan kualitas rendah
        const jpegUrl = canvas.toDataURL('image/jpeg', 0.6);
        
        // Buat link download untuk JPEG
        const link = document.createElement('a');
        link.download = `Presensi_${new Date().toISOString().slice(0, 10)}.jpg`;
        link.href = jpegUrl;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Cleanup
        document.body.removeChild(tempDiv);
        
        showNotification('âœ… Downloaded as compressed JPEG', 'info');
    }).catch(error => {
        document.body.removeChild(tempDiv);
        showNotification('âŒ All download methods failed', 'error');
    });
}

// Fallback function dengan pengaturan lebih ringan
function downloadOptimizedFallback() {
    const paperElement = document.getElementById('print-paper');
    if (!paperElement) return;
    
    const clone = paperElement.cloneNode(true);
    
    // Buat div sementara
    const tempDiv = document.createElement('div');
    tempDiv.style.cssText = `
        position: absolute;
        left: -9999px;
        top: -9999px;
        width: 210mm;
        background: white;
        padding: 20mm;
    `;
    
    tempDiv.appendChild(clone);
    document.body.appendChild(tempDiv);
    
    // Convert langsung ke JPEG dengan kualitas rendah
    html2canvas(clone, {
        scale: 0.75,
        useCORS: true,
        backgroundColor: '#ffffff',
        logging: false
    }).then(canvas => {
        // Convert to JPEG dengan kualitas rendah
        const jpegUrl = canvas.toDataURL('image/jpeg', 0.6);
        
        // Buat link download untuk JPEG
        const link = document.createElement('a');
        link.download = `Presensi_${new Date().toISOString().slice(0, 10)}.jpg`;
        link.href = jpegUrl;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Cleanup
        document.body.removeChild(tempDiv);
        
        showNotification('âœ… Downloaded as compressed JPEG', 'info');
    }).catch(error => {
        document.body.removeChild(tempDiv);
        showNotification('âŒ All download methods failed', 'error');
    });
}

// Fallback function: download as image
function downloadAsImage() {
    const paperElement = document.getElementById('print-paper');
    
    // Sembunyikan baris kosong sementara
    const rows = paperElement.querySelectorAll('#report-table-body tr');
    const originalDisplays = [];
    
    rows.forEach((row, index) => {
        originalDisplays[index] = row.style.display;
        const nameInputs = row.querySelectorAll('.name-input');
        let hasContent = false;
        
        nameInputs.forEach(input => {
            if (input.value && input.value.trim() !== '') {
                hasContent = true;
            }
        });
        
        if (!hasContent) {
            row.style.display = 'none';
        }
    });
    
    // Sembunyikan UI elements
    const uiElements = document.querySelectorAll('#hamburger-menu, #download-paper, .page-toggle-section, .btn-hamburger-menu, .btn-download-paper');
    uiElements.forEach(el => el.style.display = 'none');
    
    html2canvas(paperElement, {
        scale: 1,
        useCORS: true,
        backgroundColor: '#ffffff'
    }).then(canvas => {
        // Restore displays
        rows.forEach((row, index) => {
            row.style.display = originalDisplays[index];
        });
        uiElements.forEach(el => el.style.display = '');
        
        // Download image
        const link = document.createElement('a');
        const currentDivision = localStorage.getItem('currentDivision') || 'Khusus';
        const currentGender = localStorage.getItem('currentGender') || 'Ikhwan';
        const dateStr = new Date().toISOString().slice(0, 10);
        link.download = `Presensi_${currentDivision}_${currentGender}_${dateStr}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        showNotification('âœ… Downloaded as PNG image', 'success');
    }).catch(error => {
        console.error('Image download error:', error);
        showNotification('âŒ Download failed. Please take a screenshot manually.', 'error');
    });
}

// Add fallback button (optional)
function addFallbackDownloadButton() {
    // Check if button already exists
    if (document.getElementById('fallback-download-btn')) return;
    
    const fallbackBtn = document.createElement('button');
    fallbackBtn.id = 'fallback-download-btn';
    fallbackBtn.innerHTML = '<span class="material-symbols-outlined">download</span>';
    fallbackBtn.title = 'Download as Image';
    fallbackBtn.style.cssText = `
        position: fixed;
        top: 18.5px;
        right: 80px;
        z-index: 1001;
        background: transparent;
        border: none;
        color: var(--text);
        cursor: none;
        padding: 6px;
        border-radius: 5px;
        transition: all 0.3s ease;
    `;
    
    fallbackBtn.onclick = simpleDownload;
    
    // Remove or modify hover effect
    fallbackBtn.onmouseover = () => {
        fallbackBtn.style.color = 'var(--text)';
    };
    
    fallbackBtn.onmouseout = () => {
        fallbackBtn.style.color = 'var(--text)';
        fallbackBtn.style.backgroundColor = 'transparent';
    };
    
    // Also prevent green color on click/active state
    fallbackBtn.onmousedown = () => {
        fallbackBtn.style.color = 'var(--text)';
    };
    
    fallbackBtn.onmouseup = () => {
        fallbackBtn.style.color = 'var(--text)';
    };
    
    document.body.appendChild(fallbackBtn);
}

// Call this during initialization
addFallbackDownloadButton();

function showNotification(message, type = 'info') {
    document.querySelectorAll('.signature-notification').forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `signature-notification ${type}`;
    notification.innerHTML = message;
    
    notification.style.cssText = `
        position: fixed;
        top: 70px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        background: ${type === 'success' ? '#6bcf7f' : type === 'error' ? '#ff6b6b' : '#2196F3'};
        color: white;
        z-index: 10001;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        font-family: 'Poppins', sans-serif;
        font-size: 14px;
        animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// Debug function to check keterangan data
function debugKeteranganData() {
    const currentDivision = localStorage.getItem('currentDivision') || 'Khusus';
    const currentGender = localStorage.getItem('currentGender') || 'Ikhwan';
    const divisionKey = `${currentDivision}_${currentGender}_spreadsheetData`;
    const data = JSON.parse(localStorage.getItem(divisionKey) || '{}');
    
    console.log('=== KETERANGAN DATA DEBUG ===');
    console.log('Division Key:', divisionKey);
    console.log('Current Gender:', currentGender);
    console.log('Total entries:', Object.keys(data).length);
    
    Object.keys(data).forEach(key => {
        console.log(`${key}:`, {
            image: data[key].image ? 'âœ“' : 'âœ—',
            keterangan: data[key].keterangan || '(empty)'
        });
    });
    
    // Also check current UI values
    console.log('=== UI KETERANGAN VALUES ===');
    document.querySelectorAll('.keterangan').forEach((select, idx) => {
        const name = select.dataset.name;
        const value = select.value;
        const disabled = select.disabled;
        console.log(`[${idx}] ${name}: "${value}" (disabled: ${disabled})`);
    });
}

// Debug function to check all stored data
function checkAllStoredData() {
    const currentDivision = localStorage.getItem('currentDivision') || 'Khusus';
    const currentGender = localStorage.getItem('currentGender') || 'Ikhwan';
    
    console.log('=== ALL STORED DATA CHECK ===');
    console.log('Current Division:', currentDivision);
    console.log('Current Gender:', currentGender);
    
    // Check all keys in localStorage
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.includes(currentDivision) && key.includes(currentGender)) {
            console.log(`ðŸ“ ${key}:`, JSON.parse(localStorage.getItem(key)));
        }
    }
    
    // Check old format keys
    console.log('=== OLD FORMAT KEYS (without gender) ===');
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.includes(currentDivision) && !key.includes('_Ikhwan') && !key.includes('_Akhwat')) {
            console.log(`âš ï¸  ${key}:`, JSON.parse(localStorage.getItem(key)));
        }
    }
}

// Make functions available globally
window.saveKeterangan = saveKeterangan;
window.showSignatureModal = showSignatureModal;
window.debugKeteranganData = debugKeteranganData;
window.checkAllStoredData = checkAllStoredData;
window.simpleDownload = simpleDownload;
window.showNotification = showNotification;

// Add to the main JavaScript file
function updateFirebaseStatus() {
const authStatus = document.getElementById('auth-status-indicator');
if (!authStatus) return;

if (window.firebaseAuth && window.firebaseAuth.isInitialized) {
if (window.firebaseAuth.isLoggedIn()) {
authStatus.innerHTML = `
<span class="material-symbols-outlined" style="font-size: 12px;">
    check_circle
</span>
Firebase: Connected
`;
authStatus.style.background = '#6bcf7f';
} else {
authStatus.innerHTML = `
<span class="material-symbols-outlined" style="font-size: 12px;">
    warning
</span>
Firebase: Not Logged In
`;
authStatus.style.background = '#ffd93d';
authStatus.style.color = '#333';
}
} else {
authStatus.innerHTML = `
<span class="material-symbols-outlined" style="font-size: 12px;">
    error
</span>
Firebase: Offline
`;
authStatus.style.background = '#ff6b6b';
}
}

// Update status periodically
setInterval(updateFirebaseStatus, 5000);

// ========== SYNC STATUS FUNCTIONS ==========
function setupSyncStatusUI() {
console.log('Setting up sync status UI...');

// Create sync status indicator if it doesn't exist
if (!document.getElementById('sync-status-indicator')) {
const syncIndicator = document.createElement('div');
syncIndicator.id = 'sync-status-indicator';
syncIndicator.title = 'Sync Status';
syncIndicator.className = 'offline'; // Start as offline
document.body.appendChild(syncIndicator);
}

// Create manual sync button if it doesn't exist
if (!document.getElementById('firebase-sync-button')) {
const syncButton = document.createElement('button');
syncButton.id = 'firebase-sync-button';
syncButton.className = 'btn-sync';
syncButton.title = 'Manual Sync';
syncButton.innerHTML = '<span class="material-symbols-outlined">sync</span>';
document.body.appendChild(syncButton);

// Add click event for manual sync
syncButton.addEventListener('click', async () => {
await triggerManualSync();
});
}

// Update sync status periodically
updateSyncStatus();
setInterval(updateSyncStatus, 10000); // Update every 10 seconds

// Listen for Firebase auth state changes
window.addEventListener('authStateChanged', updateSyncStatus);

// Listen for network status changes
window.addEventListener('online', updateSyncStatus);
window.addEventListener('offline', updateSyncStatus);
}

function updateSyncStatus() {
const indicator = document.getElementById('sync-status-indicator');
const syncButton = document.getElementById('firebase-sync-button');

if (!indicator) return;

// Check if online
const isOnline = navigator.onLine;
const hasFirebase = window.dbManager && window.dbManager.isInitialized;
const isLoggedIn = window.firebaseAuth && window.firebaseAuth.isLoggedIn();

let status = 'offline';
let tooltip = 'Offline - No internet connection';

if (!isOnline) {
status = 'offline';
tooltip = 'Offline - No internet connection';
} else if (!hasFirebase) {
status = 'offline';
tooltip = 'Firebase not initialized';
} else if (!isLoggedIn) {
status = 'pending';
tooltip = 'Not logged in - Sync disabled';
} else {
status = 'online';
tooltip = 'Online - Synced with Firebase';
}

// Update indicator
indicator.className = status;
indicator.title = tooltip;

// Update sync button
if (syncButton) {
syncButton.style.display = isOnline && hasFirebase && isLoggedIn ? 'flex' : 'none';
syncButton.disabled = status !== 'online';
}

// Log status for debugging
console.log(`Sync status: ${status} - ${tooltip}`);

return status;
}

async function triggerManualSync() {
const syncButton = document.getElementById('firebase-sync-button');
const indicator = document.getElementById('sync-status-indicator');

if (!window.dbManager || !window.dbManager.isInitialized) {
showNotification('Firebase not available', 'error');
return;
}

if (!window.firebaseAuth || !window.firebaseAuth.isLoggedIn()) {
showNotification('Please login to sync', 'warning');
setTimeout(() => {
if (typeof showLoginModal === 'function') {
showLoginModal();
}
}, 500);
return;
}

// Show syncing state
if (syncButton) {
syncButton.classList.add('syncing');
syncButton.disabled = true;
}

if (indicator) {
indicator.className = 'pending';
indicator.title = 'Syncing...';
}

showNotification('Syncing with Firebase...', 'info');

try {
// Perform sync
const success = await window.dbManager.syncWithFirebase();

// Update status
if (success) {
showNotification('âœ… Sync completed successfully!', 'success');
updateSyncStatus();
} else {
showNotification('âš ï¸ Sync completed with some errors', 'warning');
updateSyncStatus();
}
} catch (error) {
console.error('Sync error:', error);
showNotification('âŒ Sync failed', 'error');
updateSyncStatus();
} finally {
// Remove syncing state
if (syncButton) {
syncButton.classList.remove('syncing');
syncButton.disabled = false;
}
}
}

// Listen for storage events to detect changes that need sync
window.addEventListener('storage', (event) => {
// If the storage event is from another tab and contains data that needs sync
if (event.key && event.key.includes('_spreadsheetData')) {
const indicator = document.getElementById('sync-status-indicator');
if (indicator && indicator.className === 'online') {
// Briefly show pending state when data changes
indicator.className = 'pending';
indicator.title = 'Data changed - sync pending';

// Revert after 2 seconds
setTimeout(updateSyncStatus, 2000);
}
}
});

// Add global function to trigger sync
window.triggerManualSync = triggerManualSync;</script>
    <script src="firebase-config.js"></script>
    <script src="firebase-auth.js"></script>
    <script src="firebase-db.js"></script>
</body>
</html>
